# Context
Filename: Migration_Task.md
Created On: 2024-12-19
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
将 AI 记账系统从依赖 scripts 目录迁移到完全使用新的服务层架构，确保应用能够完全脱离 scripts 目录的依赖。

# Project Overview
AI 记账系统已经实现了新的分层架构，包括：
- 数据模型层 (app/models/)
- 服务层 (app/services/)
- 数据库迁移支持 (migrations/)

但应用仍在使用旧的 scripts 目录中的模块来保持兼容性，需要完全迁移到新架构。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
当前 scripts 目录的使用情况：

## 应用初始化 (app/__init__.py)
- `scripts.db.db_facade.DBFacade` - 数据库操作门面
- `scripts.extractors.factory.extractor_factory.get_extractor_factory` - 提取器工厂
- 用于保持与现有代码的兼容性

## API 路由 (app/blueprints/api/routes.py)
- `scripts.analyzers.transaction_analyzer.TransactionAnalyzer` - 交易分析器
- 用于提供数据分析 API

## 所有蓝图模块
- 通过 `current_app.db_facade` 间接使用 scripts 中的数据库操作类
- 通过 `current_app.file_processor_service` 间接使用提取器工厂

## 新服务层状态
- ✅ `app/services/database_service.py` - 新的数据库服务
- ✅ `app/services/analysis_service.py` - 新的分析服务
- ✅ `app/models/` - 新的数据模型层
- ✅ `app/services/transaction_service.py` - 交易服务
- ✅ `app/services/file_processor_service.py` - 文件处理服务（但仍依赖 scripts）

# Proposed Solution (Populated by INNOVATE mode)
## 迁移策略

### 方案1：渐进式迁移
- 优点：风险较低，可以逐步验证每个组件
- 缺点：迁移时间较长，需要维护双重代码

### 方案2：一次性完全迁移
- 优点：迁移彻底，避免技术债务
- 缺点：风险较高，需要大量测试

### 推荐方案：分阶段迁移
1. 首先迁移数据分析功能（TransactionAnalyzer -> AnalysisService）
2. 然后迁移数据库操作（DBFacade -> DatabaseService + TransactionService）
3. 最后迁移文件处理功能（ExtractorFactory -> 新的提取器服务）
4. 清理和测试

# Implementation Plan (Generated by PLAN mode)

## 迁移计划详细步骤

### 阶段1：创建提取器服务
1. 分析 scripts/extractors 结构和功能
2. 在 app/services 中创建新的提取器服务
3. 实现银行数据提取功能

### 阶段2：更新 API 路由
1. 修改 app/blueprints/api/routes.py，使用 AnalysisService 替代 TransactionAnalyzer
2. 测试 API 功能

### 阶段3：更新所有蓝图
1. 修改所有蓝图，使用新的服务层替代 db_facade
2. 更新数据库操作调用

### 阶段4：更新应用初始化
1. 移除 scripts 模块的导入和初始化
2. 完全使用新的服务层

### 阶段5：更新文件处理服务
1. 重构 FileProcessorService，移除对 scripts 的依赖
2. 集成新的提取器服务

### 阶段6：测试和验证
1. 全面测试应用功能
2. 验证所有功能正常工作
3. 删除 scripts 目录

Implementation Checklist:
1. 分析 scripts/extractors 目录结构和接口
2. 创建 app/services/extractor_service.py
3. 实现银行数据提取器接口和工厂模式
4. 更新 app/blueprints/api/routes.py 使用 AnalysisService
5. 更新 app/blueprints/main/routes.py 使用新服务
6. 更新 app/blueprints/transactions/routes.py 使用新服务
7. 更新 app/blueprints/income_analysis/routes.py 使用新服务
8. 更新 app/blueprints/upload/routes.py 使用新服务
9. 重构 app/services/file_processor_service.py 移除 scripts 依赖
10. 更新 app/__init__.py 移除 scripts 导入
11. 测试应用启动和基本功能
12. 测试文件上传和处理功能
13. 测试数据分析功能
14. 测试所有蓝图路由
15. 验证数据库操作正常
16. 删除 scripts 目录
17. 最终测试和验证

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> 准备开始执行迁移计划

# Task Progress (Appended by EXECUTE mode after each step completion)
*待执行*

# Final Review (Populated by REVIEW mode)
*待完成*