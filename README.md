# AI Bookkeeping

## 项目结构
```
AiBookkeeping/
├── run.py                 # Flask应用启动文件
├── app/                   # 应用主目录
│   ├── __init__.py        # 应用工厂函数
│   ├── config.py          # 配置文件
│   ├── main/              # 主蓝图（首页、仪表盘）
│   ├── api_bp/            # API蓝图
│   ├── transactions_bp/   # 交易记录蓝图
│   ├── upload_bp/         # 文件上传蓝图
│   ├── services/          # 应用服务
│   ├── static/            # 静态文件
│   └── templates/         # HTML模板目录
│       ├── base.html      # 基础模板
│       ├── dashboard.html # 仪表盘页面
│       ├── transactions.html # 交易记录页面
│       ├── upload.html    # 上传页面
│       └── errors/        # 错误页面模板
├── data/                  # 数据目录
│   └── transactions.db    # SQLite数据库文件
├── config/                # 配置文件目录
├── logs/                  # 日志文件目录
├── scripts/               # 脚本目录
│   ├── __init__.py        # 脚本包初始化文件
│   ├── analyzers/         # 交易分析器
│   ├── common/            # 通用工具和函数
│   ├── db/                # 数据库管理器
│   ├── extractors/        # 交易数据提取器
│   │   ├── banks/         # 银行特定提取器
│   │   ├── base/          # 基础提取器类
│   │   ├── config/        # 提取器配置
│   │   ├── factory/       # 提取器工厂
│   │   └── interfaces/    # 提取器接口
│   └── visualization/     # 可视化助手
├── uploads/               # 上传文件目录
├── requirements.txt       # 依赖包列表
└── README.md              # 项目说明文档
```

## 功能特点
- 自动识别银行交易明细文件格式（目前支持建设银行、招商银行）
- 支持多银行交易数据导入和合并分析
- 自动分类交易数据（餐饮、交通、购物等15+类别）
- 多维度分析（月度、年度、类别、周度、日度）
- 核心交易和异常交易分析（识别常规支出和异常消费）
- 收入来源和支出分布分析
- 余额变动趋势和预测
- 交互式可视化报表
- 支持数据导出功能（CSV格式）
- 提供API接口支持数据查询和分析

## 数据存储
- 所有交易数据存储在SQLite数据库中，主要表结构：
  - `banks` - 银行信息表
  - `accounts` - 账户信息表
  - `transaction_types` - 交易类型表
  - `transactions` - 交易记录表
- 支持导出数据为CSV格式
- 支持按账号、日期、金额、交易类型等多维度筛选

## 标准DataFrame格式

系统处理不同银行的交易数据时，会将所有数据统一转换为标准格式的DataFrame，包含以下核心字段：

| 字段名 | 描述 | 类型 |
|-------|------|------|
| `transaction_date` | 交易日期 | 字符串(YYYY-MM-DD) |
| `amount` | 交易金额 | 浮点数 |
| `balance` | 账户余额 | 浮点数 |
| `transaction_type` | 交易类型 | 字符串 |
| `counterparty` | 交易对手方 | 字符串 |
| `currency` | 币种 | 字符串 |
| `account_number` | 账号 | 字符串 |
| `account_name` | 户名 | 字符串 |

系统流程：
1. 各银行提取器读取原始Excel文件
2. 识别账户信息和标题行
3. 通过`create_standard_dataframe`方法创建标准格式DataFrame
4. 将原始数据映射到标准字段
5. 设置默认值、验证必要字段
6. 在处理过程中添加辅助字段（如`row_index`记录原始数据行号）
7. 进行数据清洗和类型转换
8. 保存到数据库前进行最终验证

通过标准化的DataFrame格式，系统能够统一处理来自不同银行的交易数据，便于后续的分析和展示。

## 使用说明
1. 将银行交易明细文件（Excel格式）放入uploads目录或通过网页上传
2. 启动应用，系统会自动处理文件并导入数据库
3. 在仪表板查看总体分析结果
4. 在交易记录页面可查看和筛选详细交易
5. 通过API接口可以获取分析数据
6. 可以导出筛选后的数据为CSV格式

## 开发说明
- 使用Flask作为Web框架
- 采用蓝图(Blueprint)架构实现模块化设计
- 使用工厂模式创建应用实例
- 使用SQLite作为数据库
- 使用pandas进行数据分析
- 使用matplotlib和seaborn进行数据可视化
- 使用jieba分词进行交易描述分析和分类

## 交互式图表功能

系统中的所有图表都是交互式的，支持以下操作：

- **悬停查看详情**：将鼠标悬停在图表上，查看详细数据
- **图例交互**：点击图例可以隐藏/显示对应的数据系列
- **缩放功能**：使用滚轮可以放大/缩小图表，聚焦于感兴趣的数据区域
- **平移功能**：在图表上拖动可以平移查看更多数据
- **点击功能**：点击图表元素（如条形图、扇形图的扇区）可以跳转到相关的详细分析页面
- **数据标签**：部分图表显示数据标签，提供直观的数值参考

这些交互式功能让数据分析变得更加直观和灵活，用户可以根据自己的需求自由探索数据。

## 安装

1. 确保已安装Python 3.6或更高版本
2. 安装所需的依赖：

```bash
pip install -r requirements.txt
```

## 使用方法

### 方法一：直接运行
1. 在命令行中运行`python run.py`命令
2. 在浏览器中访问 http://localhost:5000

### 方法二：命令行启动
1. 打开命令提示符或终端
2. 进入项目目录
3. 运行以下命令：

```bash
python run.py
```

4. 在浏览器中访问 http://localhost:5000

## 使用流程

1. 首次使用时，系统会显示仪表盘（如果没有数据则为空）
2. 点击导航菜单中的"上传"进入上传页面
3. 选择要处理的银行交易明细Excel文件（支持多选，系统能处理来自不同银行的文件）
4. 点击"上传并处理"按钮，系统会自动：
   - 识别银行类型
   - 提取交易数据
   - 导入数据库
   - 分类交易
   - 生成分析结果
5. 处理完成后，系统会自动跳转到仪表盘显示分析结果
6. 通过顶部导航菜单，可以访问：
   - **仪表盘**：显示总体财务状况和关键指标
   - **交易记录**：查看和筛选所有交易明细
   - **上传**：上传新的交易数据

## API接口

系统提供以下API接口：

1. `/api/data` - 获取交易分析数据
   - 参数：
     - `start_date`：开始日期（格式：YYYY-MM-DD）
     - `end_date`：结束日期（格式：YYYY-MM-DD）
     - `account_number`：账号（可选）
     - `currency`：币种（可选）
     - `account_name`：户名（可选）

2. `/api/export_transactions` - 导出交易记录为CSV
   - 参数：
     - `account_number`：账号（可选）
     - `start_date`：开始日期（可选）
     - `end_date`：结束日期（可选）
     - `min_amount`：最小金额（可选）
     - `max_amount`：最大金额（可选）
     - `type`：交易类型（可选）
     - `counterparty`：交易对手（可选）
     - `currency`：币种（可选）
     - `account_name_filter`：账户名称（可选）
     - `distinct`：是否去重（可选，true/false）

## 数据安全

- 所有数据都在本地处理和存储，不会上传到任何服务器
- 交易数据中的账号信息已做脱敏处理
- 使用SQLite WAL模式提高数据库并发性能和安全性

## 系统要求

- 操作系统: Windows 7/10/11, macOS, Linux
- 浏览器: Chrome, Firefox, Edge (最新版本)
- 内存: 至少4GB RAM
- 硬盘: 至少100MB可用空间

## 注意事项

- 支持的文件类型：.xlsx, .xls
- 上传的文件成功处理后会被删除（不保留原始文件）
- 所有数据存储在SQLite数据库中
- 所有文件采用UTF-8编码

## 交易类别说明

系统会根据交易描述自动对交易进行分类，主要分类包括：

- **收入类**：
  - 工资
  - 利息
  - 退款
  - 其他收入

- **支出类**：
  - 餐饮（关键词：餐、饮、食、厅、粉、小吃、肉、面、饭、咖啡、外卖、美团等）
  - 交通（关键词：地铁、公交、出行、滴滴、顺风车等）
  - 购物（关键词：购、商城、店、京东、淘宝、天猫、拼多多、电商、超市等）
  - 娱乐（关键词：娱乐、电影、游戏、网盘、会员、视频、音乐、直播等）
  - 住房（关键词：房、租、装修、家具、维意、定制、水电、物业、宽带等）
  - 医疗（关键词：药、医、诊所、医院、保健、健康等）
  - 教育（关键词：学、书、教育、培训、课程等）
  - 通讯（关键词：通讯、话费、手机、流量、电信、移动、联通等）
  - 投资（关键词：基金、股票、理财、投资等）
  - 保险（关键词：保险、太平洋人寿等）

- **中性类**：
  - 转账
  - 其他

## 最近代码优化

为了提高代码质量和可维护性，我们对项目结构和代码进行了以下优化：

1. **模块化架构**：
   - 重构为使用Flask蓝图(Blueprint)的模块化结构
   - 采用应用工厂模式便于测试和多环境部署
   - 将功能划分为独立蓝图，提高代码可维护性

2. **脚本组织优化**：
   - 重构scripts目录，分为analyzers、common、db、extractors和visualization子目录
   - 使用工厂模式和策略模式实现可扩展的提取器系统
   - 改进错误处理和日志系统

3. **提取器结构优化**：
   - 在基类`BankTransactionExtractor`中添加了`create_standard_dataframe`方法，用于创建标准格式的DataFrame
   - 统一了`extract_account_info`方法的接口，使其返回格式一致
   - 从子类中移除了重复的代码逻辑，如标准日期字段、默认值设置等
   - 改进了数据提取失败的处理机制，确保在关键数据字段缺失时明确返回提取失败，而不是使用默认值
   - 增强了数据验证逻辑，对于账号、交易日期、金额等关键字段进行严格检查
   - 添加了`validate_transaction_data`方法，对标准格式DataFrame的所有字段进行全面验证
   - 优化了验证流程，将严格验证集中在基类的`save_to_database`方法中执行，避免在各银行提取器中重复验证
   - 在数据导入数据库前进行严格验证，确保只有高质量的数据被保存
   - 通过这些修改，使得添加新银行的提取器更加简单，仅需专注于特定银行的数据提取逻辑

4. **分析能力增强**：
   - 增加了核心交易识别功能，可自动识别常规收支模式
   - 增加了异常交易检测功能，基于多种统计方法检测异常消费
   - 增强了多维度分析能力（日、周、月、年、类别）
   - 改进了分类算法，提高了交易分类准确性 