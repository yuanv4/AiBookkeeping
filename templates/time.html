{% extends "base.html" %}

{% block title %}时间分析 - 银行账单分析系统{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-clock me-2"></i>时间分析</h1>

<!-- 图表部分 -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-calendar-week me-2"></i>按星期消费统计
            </div>
            <div class="card-body chart-container">
                {% if weekday_chart %}
                <img src="data:image/png;base64,{{ weekday_chart }}" class="img-fluid" alt="按星期消费统计">
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-calendar-week fa-3x mb-3"></i>
                    <p>暂无按星期统计数据</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-chart-line me-2"></i>日消费趋势
            </div>
            <div class="card-body chart-container">
                {% if daily_chart %}
                <img src="data:image/png;base64,{{ daily_chart }}" class="img-fluid" alt="日消费趋势">
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>暂无日消费趋势数据</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 按星期详情表格 -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-table me-2"></i>按星期消费详情
    </div>
    <div class="card-body">
        {% if weekly_stats|length > 0 %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>星期</th>
                        <th>总支出 (元)</th>
                        <th>交易笔数</th>
                        <th>平均值 (元/笔)</th>
                        <th>占比</th>
                        <th>可视化</th>
                    </tr>
                </thead>
                <tbody>
                    {% set total_expense = weekly_stats|sum(attribute='总额') %}
                    {% for day in weekly_stats %}
                    <tr>
                        <td>{{ day.星期名 }}</td>
                        <td>{{ "%.2f"|format(day.总额) }}</td>
                        <td>{{ day.笔数 }}</td>
                        <td>{{ "%.2f"|format(day.平均值) }}</td>
                        <td>{{ "%.2f"|format(day.总额 / total_expense * 100) }}%</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar bg-primary" role="progressbar" 
                                     style="width: {{ day.总额 / total_expense * 100 }}%;" 
                                     aria-valuenow="{{ day.总额 / total_expense * 100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-primary">
                    <tr>
                        <th>总计</th>
                        <th>{{ "%.2f"|format(weekly_stats|sum(attribute='总额')) }}</th>
                        <th>{{ weekly_stats|sum(attribute='笔数') }}</th>
                        <th>{{ "%.2f"|format(weekly_stats|sum(attribute='总额') / weekly_stats|sum(attribute='笔数')) }}</th>
                        <th>100.00%</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- 按星期分析洞察 -->
        <div class="mt-4">
            <h4><i class="fas fa-lightbulb me-2"></i>时间消费洞察</h4>
            
            {% set max_day = weekly_stats|sort(attribute='总额')|last %}
            {% set min_day = weekly_stats|sort(attribute='总额')|first %}
            {% set max_day_count = weekly_stats|sort(attribute='笔数')|last %}
            
            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-arrow-up me-2"></i>消费最高的星期</h5>
                        <p>
                            <strong>{{ max_day.星期名 }}</strong> 是消费金额最高的一天，
                            总支出 <strong>{{ "%.2f"|format(max_day.总额) }}</strong> 元，
                            占总支出的 <strong>{{ "%.2f"|format(max_day.总额 / total_expense * 100) }}%</strong>，
                            共 {{ max_day.笔数 }} 笔交易，平均每笔 {{ "%.2f"|format(max_day.平均值) }} 元。
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-success">
                        <h5><i class="fas fa-arrow-down me-2"></i>消费最低的星期</h5>
                        <p>
                            <strong>{{ min_day.星期名 }}</strong> 是消费金额最低的一天，
                            总支出 <strong>{{ "%.2f"|format(min_day.总额) }}</strong> 元，
                            占总支出的 <strong>{{ "%.2f"|format(min_day.总额 / total_expense * 100) }}%</strong>，
                            共 {{ min_day.笔数 }} 笔交易，平均每笔 {{ "%.2f"|format(min_day.平均值) }} 元。
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-info">
                        <h5><i class="fas fa-shopping-cart me-2"></i>交易次数最多的星期</h5>
                        <p>
                            <strong>{{ max_day_count.星期名 }}</strong> 是交易笔数最多的一天，
                            共 <strong>{{ max_day_count.笔数 }}</strong> 笔交易，
                            总支出 {{ "%.2f"|format(max_day_count.总额) }} 元，
                            平均每笔 {{ "%.2f"|format(max_day_count.平均值) }} 元。
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-calendar-day me-2"></i>工作日与周末对比</h5>
                        {% set weekdays = weekly_stats[:5] %}
                        {% set weekends = weekly_stats[5:] %}
                        {% set weekday_total = weekdays|sum(attribute='总额') %}
                        {% set weekend_total = weekends|sum(attribute='总额') %}
                        {% set weekday_count = weekdays|sum(attribute='笔数') %}
                        {% set weekend_count = weekends|sum(attribute='笔数') %}
                        
                        <p>
                            工作日（周一至周五）总支出 <strong>{{ "%.2f"|format(weekday_total) }}</strong> 元，
                            占总支出的 <strong>{{ "%.2f"|format(weekday_total / total_expense * 100) }}%</strong>，
                            共 {{ weekday_count }} 笔交易，平均每笔 {{ "%.2f"|format(weekday_total / weekday_count) }} 元。
                        </p>
                        <p>
                            周末（周六、周日）总支出 <strong>{{ "%.2f"|format(weekend_total) }}</strong> 元，
                            占总支出的 <strong>{{ "%.2f"|format(weekend_total / total_expense * 100) }}%</strong>，
                            共 {{ weekend_count }} 笔交易，平均每笔 {{ "%.2f"|format(weekend_total / weekend_count) }} 元。
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- 优化建议 -->
            <div class="alert alert-secondary">
                <h5><i class="fas fa-bullseye me-2"></i>消费习惯优化建议</h5>
                <ul>
                    <li>
                        在消费高峰日 <strong>{{ max_day.星期名 }}</strong>，可以提前规划消费，减少冲动消费的可能性。
                    </li>
                    <li>
                        {% if weekend_total > weekday_total %}
                        您的周末消费明显高于工作日，可以考虑寻找更经济的周末娱乐方式或活动。
                        {% elif weekday_total > weekend_total %}
                        您的工作日消费高于周末，可能与日常通勤和工作餐有关，可以考虑自带午餐或寻找更经济的交通方式。
                        {% else %}
                        您的工作日和周末消费相对平衡，继续保持良好的消费习惯。
                        {% endif %}
                    </li>
                    <li>
                        {% if max_day_count.星期 == max_day.星期 %}
                        您在 {{ max_day.星期名 }} 既有最高的消费金额，也有最多的交易次数，说明这一天可能是您的购物或社交日，可以考虑将部分活动分散到其他天。
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
            <i class="fas fa-table fa-3x mb-3"></i>
            <p>暂无按星期统计数据</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %} 