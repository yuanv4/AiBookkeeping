{% extends "base.html" %}

{% block title %}商户分析 - 银行账单分析系统{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-store me-2"></i>商户分析</h1>

<!-- 图表部分 -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-chart-bar me-2"></i>消费最多的商户
    </div>
    <div class="card-body chart-container">
        {% if merchant_data %}
        <canvas id="merchantChart"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">
            <i class="fas fa-chart-bar fa-3x mb-3"></i>
            <p>暂无商户统计数据</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- 商户表格 - 按交易金额 -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-money-bill-wave me-2"></i>消费金额最高的商户
    </div>
    <div class="card-body">
        {% if top_merchants.by_amount|length > 0 %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>商户名称</th>
                        <th>消费总额 (元)</th>
                        <th>交易笔数</th>
                        <th>平均消费 (元/笔)</th>
                        <th>可视化</th>
                    </tr>
                </thead>
                <tbody>
                    {% set total_amount = top_merchants.by_amount|sum(attribute='总额') %}
                    {% for merchant in top_merchants.by_amount %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ merchant.商户 }}</td>
                        <td>{{ "%.2f"|format(merchant.总额) }}</td>
                        <td>{{ merchant.笔数 }}</td>
                        <td>{{ "%.2f"|format(merchant.平均值) }}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar bg-danger" role="progressbar" 
                                     style="width: {{ merchant.总额 / top_merchants.by_amount[0].总额 * 100 }}%;" 
                                     aria-valuenow="{{ merchant.总额 / top_merchants.by_amount[0].总额 * 100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
            <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
            <p>暂无商户消费数据</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- 商户表格 - 按交易次数 -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-receipt me-2"></i>交易次数最多的商户
    </div>
    <div class="card-body">
        {% if top_merchants.by_count|length > 0 %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>商户名称</th>
                        <th>交易笔数</th>
                        <th>消费总额 (元)</th>
                        <th>平均消费 (元/笔)</th>
                        <th>可视化</th>
                    </tr>
                </thead>
                <tbody>
                    {% for merchant in top_merchants.by_count %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ merchant.商户 }}</td>
                        <td>{{ merchant.笔数 }}</td>
                        <td>{{ "%.2f"|format(merchant.总额) }}</td>
                        <td>{{ "%.2f"|format(merchant.平均值) }}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: {{ merchant.笔数 / top_merchants.by_count[0].笔数 * 100 }}%;" 
                                     aria-valuenow="{{ merchant.笔数 / top_merchants.by_count[0].笔数 * 100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
            <i class="fas fa-receipt fa-3x mb-3"></i>
            <p>暂无商户交易次数数据</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- 商户分析洞察 -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-lightbulb me-2"></i>商户消费洞察
    </div>
    <div class="card-body">
        {% if top_merchants.by_amount|length > 0 and top_merchants.by_count|length > 0 %}
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-danger">
                    <h5><i class="fas fa-money-bill-wave me-2"></i>消费金额最高的商户</h5>
                    <p>
                        您在 <strong>{{ top_merchants.by_amount[0].商户 }}</strong> 的消费总额为 
                        <strong>{{ "%.2f"|format(top_merchants.by_amount[0].总额) }}</strong> 元，
                        共 {{ top_merchants.by_amount[0].笔数 }} 笔交易，
                        平均每笔 {{ "%.2f"|format(top_merchants.by_amount[0].平均值) }} 元。
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h5><i class="fas fa-receipt me-2"></i>交易次数最多的商户</h5>
                    <p>
                        您在 <strong>{{ top_merchants.by_count[0].商户 }}</strong> 有 
                        <strong>{{ top_merchants.by_count[0].笔数 }}</strong> 笔交易，
                        消费总额为 {{ "%.2f"|format(top_merchants.by_count[0].总额) }} 元，
                        平均每笔 {{ "%.2f"|format(top_merchants.by_count[0].平均值) }} 元。
                    </p>
                </div>
            </div>
        </div>
        
        <div class="alert alert-warning">
            <h5><i class="fas fa-chart-line me-2"></i>商户消费特点分析</h5>
            <ul>
                {% if top_merchants.by_amount[0].商户 == top_merchants.by_count[0].商户 %}
                <li>
                    <strong>{{ top_merchants.by_amount[0].商户 }}</strong> 既是您消费金额最高的商户，也是交易次数最多的商户，
                    这说明您对该商户有较高的依赖性。
                </li>
                {% else %}
                <li>
                    您在 <strong>{{ top_merchants.by_amount[0].商户 }}</strong> 的消费金额最高，
                    在 <strong>{{ top_merchants.by_count[0].商户 }}</strong> 的交易次数最多，
                    这反映了您的消费呈现"大额消费"和"高频消费"分离的特点。
                </li>
                {% endif %}
                
                {% set high_avg = top_merchants.by_amount|sort(attribute='平均值')|last %}
                {% set low_avg = top_merchants.by_amount|sort(attribute='平均值')|first %}
                
                <li>
                    您在 <strong>{{ high_avg.商户 }}</strong> 的平均消费最高，达到 <strong>{{ "%.2f"|format(high_avg.平均值) }}</strong> 元/笔，
                    这可能是大额支出项目或奢侈消费。
                </li>
                <li>
                    您在 <strong>{{ low_avg.商户 }}</strong> 的平均消费最低，为 <strong>{{ "%.2f"|format(low_avg.平均值) }}</strong> 元/笔，
                    这可能是日常小额消费。
                </li>
            </ul>
        </div>
        
        <!-- 优化建议 -->
        <div class="alert alert-secondary">
            <h5><i class="fas fa-bullseye me-2"></i>优化建议</h5>
            <ul>
                <li>
                    针对高频商户 <strong>{{ top_merchants.by_count[0].商户 }}</strong>，
                    {% if top_merchants.by_count[0].平均值 > 50 %}
                    可以考虑寻找类似但更经济的替代选择，或利用会员优惠、促销活动等降低消费。
                    {% else %}
                    虽然单笔金额不大，但由于频次高，累计金额可观，可以考虑减少消费频次或寻找批量购买方式降低总成本。
                    {% endif %}
                </li>
                <li>
                    针对高额商户 <strong>{{ top_merchants.by_amount[0].商户 }}</strong>，
                    {% if top_merchants.by_amount[0].笔数 < 5 %}
                    虽然交易次数不多，但单笔金额较大，建议在大额消费前充分比较和考虑，避免冲动消费。
                    {% else %}
                    既有高消费金额又有较多交易次数，应重点关注和控制在该商户的支出。
                    {% endif %}
                </li>
                <li>
                    定期审视高频和高额商户的消费情况，评估是否存在更经济的替代方案，或是否可以减少非必要支出。
                </li>
            </ul>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
            <i class="fas fa-lightbulb fa-3x mb-3"></i>
            <p>暂无商户分析数据</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 颜色配置
const colorPalette = {
    primary: '#4663ac',
    success: '#47b881',
    danger: '#ec4c47',
    warning: '#ffab00',
    info: '#1070ca',
    neutral: ['#4663ac', '#6c84ca', '#8ea2d8', '#b0bfe5', '#d2dcf3']
};

document.addEventListener('DOMContentLoaded', function() {
    {% if merchant_data %}
    // 初始化商户图表
    const merchantCtx = document.getElementById('merchantChart').getContext('2d');
    
    // 安全解析数据，确保是有效的JavaScript数组
    let labels = [];
    let values = [];
    let counts = [];
    
    try {
        // 使用更加安全的方式解析JSON数据
        const merchantData = {{ merchant_data|tojson|safe }};
        
        // 检查数据是否存在并且格式正确
        if (merchantData && merchantData.labels && Array.isArray(merchantData.labels)) {
            labels = merchantData.labels;
        } else {
            console.error('商户标签数据不存在或格式不正确');
        }
        
        if (merchantData && merchantData.values && Array.isArray(merchantData.values)) {
            values = merchantData.values.map(v => typeof v === 'string' ? parseFloat(v) || 0 : v);
        } else {
            console.error('商户金额数据不存在或格式不正确');
        }
        
        if (merchantData && merchantData.counts && Array.isArray(merchantData.counts)) {
            counts = merchantData.counts.map(c => typeof c === 'string' ? parseInt(c) || 0 : c);
        } else {
            console.error('商户笔数数据不存在或格式不正确');
        }
    } catch (error) {
        console.error('解析商户数据时出错:', error);
    }
    
    // 仅在有有效数据时创建图表
    if (labels.length > 0 && values.length > 0) {
        const merchantChart = new Chart(merchantCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '消费金额',
                    data: values,
                    backgroundColor: colorPalette.info,
                    borderColor: colorPalette.info,
                    borderWidth: 1
                }, {
                    label: '交易笔数',
                    data: counts,
                    type: 'line',
                    fill: false,
                    borderColor: colorPalette.warning,
                    backgroundColor: colorPalette.warning,
                    pointBorderColor: colorPalette.warning,
                    pointBackgroundColor: '#fff',
                    pointRadius: 4,
                    borderWidth: 2,
                    yAxisID: 'y1'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.x !== null) {
                                    if (label.includes('金额')) {
                                        label += new Intl.NumberFormat('zh-CN', { 
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2 
                                        }).format(context.parsed.x);
                                    } else {
                                        label += context.parsed.x;
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '消费金额'
                        },
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('zh-CN', { 
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0 
                                }).format(value);
                            }
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            callback: function(value, index) {
                                let label = this.getLabelForValue(value);
                                // 如果商户名称太长，截断并添加省略号
                                if (label && label.length > 15) {
                                    return label.substring(0, 15) + '...';
                                }
                                return label;
                            }
                        }
                    },
                    y1: {
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '交易笔数'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                onClick: function(e, elements) {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const label = this.data.labels[index];
                        // 如果点击了某个商户，跳转到该商户的详情页面
                        window.location.href = `/merchant?merchant=${encodeURIComponent(label)}`;
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });
    } else {
        // 如果没有有效数据，显示错误消息
        const container = document.getElementById('merchantChart').parentNode;
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="material-icons-round" style="font-size: 48px; color: rgba(0,0,0,0.15);">error_outline</i>
                <p class="mt-3 text-muted">无法加载商户图表数据</p>
            </div>
        `;
    }
    {% endif %}
});
</script>
{% endblock %} 