{% extends "base.html" %}

{% block title %}交易记录 - 银行账单分析系统{% endblock %}

{% block header_title %}交易记录{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-2">交易记录</h1>
        <p class="subheading">查看和搜索您的所有交易记录，共 <span class="badge bg-primary rounded-pill" id="total-count">{{ total_count }}</span> 条</p>
    </div>
</div>

<!-- 筛选表单 -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex align-items-center">
            <i class="material-icons-round me-2" style="color: var(--primary);">filter_list</i>
            <span>筛选条件</span>
        </div>
    </div>
    <div class="card-body">
        <form id="filter-form" class="row g-3">
            <div class="col-lg-4 col-md-6">
                <label for="category" class="form-label">交易类型</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="material-icons-round" style="font-size: 18px;">category</i></span>
                    <select class="form-select" id="category">
                        <option value="">全部类型</option>
                        {% for cat in data.categories %}
                        <option value="{{ cat }}" {% if data.filters.type == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <label for="bank" class="form-label">银行</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="material-icons-round" style="font-size: 18px;">account_balance</i></span>
                    <select class="form-select" id="bank">
                        <option value="">全部银行</option>
                        <!-- 银行选项将通过JavaScript动态填充 -->
                    </select>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <label for="account" class="form-label">卡号</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="material-icons-round" style="font-size: 18px;">credit_card</i></span>
                    <select class="form-select" id="account">
                        <option value="">全部卡号</option>
                        <!-- 卡号选项将通过JavaScript动态填充 -->
                    </select>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <label for="search" class="form-label">关键词搜索</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="material-icons-round" style="font-size: 18px;">search</i></span>
                    <input type="text" class="form-control" id="search" placeholder="输入关键词...">
                </div>
            </div>
            <div class="col-12 text-end mt-4">
                <button type="button" id="reset-filters" class="btn btn-outline-secondary me-2">
                    <i class="material-icons-round" style="font-size: 18px; vertical-align: text-bottom;">refresh</i>
                    重置
                </button>
                <button type="button" id="apply-filters" class="btn btn-primary">
                    <i class="material-icons-round" style="font-size: 18px; vertical-align: text-bottom;">search</i>
                    搜索
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 交易记录表格 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <i class="material-icons-round me-2" style="color: var(--primary);">receipt_long</i>
            <span>交易明细</span>
        </div>
        <div>
            <button id="download-csv" class="btn btn-sm btn-outline-primary me-2">
                <i class="material-icons-round" style="font-size: 18px; vertical-align: text-bottom;">download</i>
                导出CSV
            </button>
            <span class="badge rounded-pill bg-primary" id="filtered-count">{{ data.transactions|length }}</span> / <span class="badge rounded-pill bg-secondary">{{ total_count }}</span>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="transactions-table">
                <thead>
                    <tr>
                        <th>序号</th>
                        <th>日期</th>
                        <th>类型</th>
                        <th>交易对象</th>
                        <th>金额</th>
                        <th>账户余额</th>
                        <th>账号</th>
                        <th>银行</th>
                    </tr>
                </thead>
                <tbody id="transactions-body">
                    <!-- 表格内容将通过JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
        
        <!-- 分页控件 -->
        <div id="pagination-container" class="p-3">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分页按钮将通过JavaScript动态填充 -->
            </ul>
        </div>
        
        <!-- 无数据提示 -->
        <div id="no-data" class="text-center py-5" style="display: none;">
            <i class="material-icons-round" style="font-size: 48px; color: rgba(0,0,0,0.15);">search_off</i>
            <p class="mt-3 text-muted">没有找到匹配的交易记录</p>
            <button id="reset-all" class="btn btn-outline-primary mt-2">
                <i class="material-icons-round" style="font-size: 18px; vertical-align: text-bottom;">refresh</i>
                重置筛选条件
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取分页信息
        let totalItems = {{ total_count }};
        let currentPage = {{ data.pagination.page }};
        let itemsPerPage = {{ data.pagination.limit }};
        let totalPages = {{ data.pagination.pages }};
        
        // 初始化数据
        let transactions = [];
        try {
            // 尝试解析交易数据
            console.log("正在解析交易数据");
            // 使用直接传递的JSON字符串
            const transactionsJson = {{ transactions_json|safe }};
            // 如果已经是对象，直接使用；如果是字符串，则解析
            if (typeof transactionsJson === 'string') {
                transactions = JSON.parse(transactionsJson);
            } else {
                transactions = transactionsJson;
            }
            console.log(`成功解析${transactions.length}条交易记录`);
            
            // 检查第一条记录
            if (transactions.length > 0) {
                console.log("第一条记录示例:", transactions[0]);
            }
            
            // 填充银行和卡号筛选器选项
            populateBankAndAccountOptions();
        } catch (error) {
            console.error("解析交易数据时出错:", error);
            // 解析失败时使用空数组
            transactions = [];
        }
        
        // 初始化表格
        renderTable();
        
        // 绑定事件
        document.getElementById('apply-filters').addEventListener('click', applyFilters);
        document.getElementById('reset-filters').addEventListener('click', resetFilters);
        document.getElementById('reset-all').addEventListener('click', resetFilters);
        document.getElementById('download-csv').addEventListener('click', downloadCSV);
        
        // 银行选择变化时更新卡号选项
        document.getElementById('bank').addEventListener('change', function() {
            updateAccountOptions(this.value, '');
        });
        
        /**
         * 填充银行和卡号选项
         */
        function populateBankAndAccountOptions() {
            // 从交易记录中提取银行和账号
            const banks = new Set();
            const accounts = {};
            
            transactions.forEach(transaction => {
                const bank = transaction['银行'];
                const accountNumber = transaction['账号'];
                
                if (bank) {
                    banks.add(bank);
                    
                    // 按银行分组账号
                    if (!accounts[bank]) {
                        accounts[bank] = new Set();
                    }
                    if (accountNumber) {
                        accounts[bank].add(accountNumber);
                    }
                }
            });
            
            // 获取URL参数中的已选银行和账号
            const urlParams = new URLSearchParams(window.location.search);
            const selectedBank = urlParams.get('bank') || '';
            const selectedAccount = urlParams.get('account_number') || '';
            
            // 填充银行选项
            const bankSelect = document.getElementById('bank');
            bankSelect.innerHTML = '<option value="">全部银行</option>';
            
            Array.from(banks).sort().forEach(bank => {
                const option = document.createElement('option');
                option.value = bank;
                option.textContent = bank;
                if (bank === selectedBank) {
                    option.selected = true;
                }
                bankSelect.appendChild(option);
            });
            
            // 初始化时显示所有卡号或选择的银行的卡号
            updateAccountOptions(selectedBank, selectedAccount);
        }
        
        /**
         * 根据选择的银行更新卡号选项
         */
        function updateAccountOptions(selectedBank, preSelectedAccount) {
            const accountSelect = document.getElementById('account');
            accountSelect.innerHTML = '<option value="">全部卡号</option>';
            
            // 如果没有提供预选账号，尝试从URL获取
            if (!preSelectedAccount) {
                const urlParams = new URLSearchParams(window.location.search);
                preSelectedAccount = urlParams.get('account_number') || '';
            }
            
            // 从交易数据中提取账号
            const accountNumbers = new Set();
            
            transactions.forEach(transaction => {
                const bank = transaction['银行'];
                const accountNumber = transaction['账号'];
                
                if (accountNumber && (!selectedBank || bank === selectedBank)) {
                    accountNumbers.add(accountNumber);
                }
            });
            
            // 填充账号选项
            Array.from(accountNumbers).sort().forEach(accountNumber => {
                const option = document.createElement('option');
                option.value = accountNumber;
                option.textContent = accountNumber;
                if (accountNumber === preSelectedAccount) {
                    option.selected = true;
                }
                accountSelect.appendChild(option);
            });
        }
        
        /**
         * 应用筛选条件
         */
        function applyFilters() {
            // 获取筛选条件
            const category = document.getElementById('category').value;
            const bank = document.getElementById('bank').value;
            const account = document.getElementById('account').value;
            const search = document.getElementById('search').value.toLowerCase();
            
            // 构建查询参数
            let queryParams = new URLSearchParams(window.location.search);
            queryParams.set('page', '1'); // 重置到第一页
            
            if (category) queryParams.set('type', category);
            else queryParams.delete('type');
            
            if (search) queryParams.set('counterparty', search);
            else queryParams.delete('counterparty');
            
            // 银行参数
            if (bank) queryParams.set('bank', bank);
            else queryParams.delete('bank');
            
            // 账号参数 - 在后端需要转换为account_id
            if (account) queryParams.set('account_number', account);
            else queryParams.delete('account_number');
            
            // 重新加载页面
            window.location.href = window.location.pathname + '?' + queryParams.toString();
        }
        
        /**
         * 重置筛选条件
         */
        function resetFilters() {
            window.location.href = window.location.pathname;
        }
        
        /**
         * 渲染表格
         */
        function renderTable() {
            console.log("开始渲染表格，数据条数:", transactions.length);
            
            // 更新计数
            document.getElementById('filtered-count').textContent = transactions.length;
            document.getElementById('total-count').textContent = totalItems;
            
            // 显示/隐藏无数据提示
            if (transactions.length === 0) {
                document.getElementById('transactions-table').style.display = 'none';
                document.getElementById('pagination-container').style.display = 'none';
                document.getElementById('no-data').style.display = 'block';
                return;
            } else {
                document.getElementById('transactions-table').style.display = 'table';
                document.getElementById('pagination-container').style.display = 'block';
                document.getElementById('no-data').style.display = 'none';
            }
            
            // 渲染表格内容
            const tbody = document.getElementById('transactions-body');
            tbody.innerHTML = '';
            
            // 计算序号起始值
            const startIndex = (currentPage - 1) * itemsPerPage;
            
            transactions.forEach((transaction, index) => {
                try {
                    const tr = document.createElement('tr');
                    
                    // 获取日期，确保日期存在
                    let formattedDate = transaction['交易日期'] || '';
                    
                    // 格式化金额，确保金额是数字，否则默认为0
                    let amount = 0;
                    try {
                        amount = parseFloat(transaction['交易金额']);
                        if (isNaN(amount)) amount = 0;
                    } catch (e) {
                        console.error("金额解析错误:", e);
                        amount = 0;
                    }
                    const formattedAmount = amount.toFixed(2);
                    const amountClass = amount > 0 ? 'positive' : (amount < 0 ? 'negative' : '');
                    
                    // 格式化余额，确保余额是数字，否则默认为0
                    let balance = 0;
                    try {
                        balance = parseFloat(transaction['账户余额']);
                        if (isNaN(balance)) balance = 0;
                    } catch (e) {
                        console.error("余额解析错误:", e);
                        balance = 0;
                    }
                    const formattedBalance = balance.toFixed(2);
                    
                    // 确定交易类型标签颜色
                    let typeClass = 'bg-primary';
                    let transactionType = transaction['交易类型'] || '未知';
                    if (transactionType.includes('退款')) {
                        typeClass = 'bg-success';
                    } else if (transactionType.includes('转账')) {
                        typeClass = 'bg-info';
                    } else if (transactionType.includes('收入') || transactionType.includes('收款')) {
                        typeClass = 'bg-success';
                    }
                    
                    // 设置交易对象
                    const transactionObject = transaction['交易对象'] || '';
                    
                    // 获取银行和账号信息
                    const bank = transaction['银行'] || '未知银行';
                    const accountNumber = transaction['账号'] || '未知账号';
                    
                    tr.innerHTML = `
                        <td>${startIndex + index + 1}</td>
                        <td>${formattedDate}</td>
                        <td><span class="badge ${typeClass}">${transactionType}</span></td>
                        <td>${transactionObject}</td>
                        <td class="${amountClass}">${amount > 0 ? '+' : ''}${formattedAmount}</td>
                        <td>${formattedBalance}</td>
                        <td><span class="badge bg-light text-dark">${accountNumber}</span></td>
                        <td><span class="badge bg-secondary">${bank}</span></td>
                    `;
                    
                    tbody.appendChild(tr);
                } catch (error) {
                    console.error("渲染表格行时出错:", error, "数据:", transaction);
                }
            });
            
            // 渲染分页控件
            renderPagination();
        }
        
        /**
         * 渲染分页控件
         */
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // 如果只有一页，不显示分页
            if (totalPages <= 1) {
                document.getElementById('pagination-container').style.display = 'none';
                return;
            }
            
            document.getElementById('pagination-container').style.display = 'block';
            
            // 上一页按钮
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" aria-label="上一页">
                    <i class="material-icons-round">chevron_left</i>
                </a>
            `;
            if (currentPage > 1) {
                prevLi.addEventListener('click', () => goToPage(currentPage - 1));
            }
            pagination.appendChild(prevLi);
            
            // 计算显示的页码范围
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // 调整，确保显示5个页码
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(5, totalPages);
                } else if (endPage === totalPages) {
                    startPage = Math.max(1, totalPages - 4);
                }
            }
            
            // 第一页
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = '<a class="page-link" href="#">1</a>';
                firstLi.addEventListener('click', () => goToPage(1));
                pagination.appendChild(firstLi);
                
                // 省略号
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
            }
            
            // 页码
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageLi.addEventListener('click', () => goToPage(i));
                pagination.appendChild(pageLi);
            }
            
            // 省略号和最后一页
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
                lastLi.addEventListener('click', () => goToPage(totalPages));
                pagination.appendChild(lastLi);
            }
            
            // 下一页按钮
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" aria-label="下一页">
                    <i class="material-icons-round">chevron_right</i>
                </a>
            `;
            if (currentPage < totalPages) {
                nextLi.addEventListener('click', () => goToPage(currentPage + 1));
            }
            pagination.appendChild(nextLi);
        }
        
        /**
         * 跳转到指定页
         */
        function goToPage(page) {
            // 更新URL参数
            let queryParams = new URLSearchParams(window.location.search);
            queryParams.set('page', page);
            window.location.href = window.location.pathname + '?' + queryParams.toString();
        }
        
        /**
         * 导出CSV文件
         */
        function downloadCSV() {
            // 构建API请求URL
            let queryParams = new URLSearchParams(window.location.search);
            queryParams.delete('page');
            queryParams.delete('limit');
            queryParams.set('format', 'csv');
            
            // 创建下载链接
            const downloadUrl = `/api/export_transactions?${queryParams.toString()}`;
            window.location.href = downloadUrl;
        }
    });
</script>

<style>
    .positive {
        color: #28a745;
        font-weight: bold;
    }
    .negative {
        color: #dc3545;
        font-weight: bold;
    }
</style>
{% endblock %} 