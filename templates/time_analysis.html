{% extends "base.html" %}

{% block title %}时间分析 - 银行账单分析系统{% endblock %}

{% block header_title %}时间分析{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-2">时间分析</h1>
        <p class="subheading">从不同时间维度分析您的收支情况，包括周、月、年度分析</p>
    </div>
</div>

<!-- 全局无数据提示 -->
{% if not weekday_data and not yearly_data and not monthly_data %}
<div class="alert alert-warning" role="alert">
    <h4 class="alert-heading"><i class="material-icons-round me-2" style="vertical-align: -4px;">info</i>暂无分析数据</h4>
    <p>当前没有交易数据可供分析。这可能是因为：</p>
    <ul>
        <li>数据库中尚未导入交易数据</li>
        <li>导入的数据不完整或格式不正确</li>
    </ul>
    <hr>
    <p class="mb-0">您可以尝试：</p>
    <ul>
        <li>导入更多的交易数据</li>
        <li>检查导入的数据是否正确</li>
    </ul>
</div>
{% endif %}

<!-- 选项卡导航 -->
<div class="card mb-4">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="timeAnalysisTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab" aria-controls="weekly" aria-selected="true">
                    <i class="material-icons-round me-1" style="font-size: 18px; vertical-align: -4px;">view_week</i>周分析
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab" aria-controls="monthly" aria-selected="false">
                    <i class="material-icons-round me-1" style="font-size: 18px; vertical-align: -4px;">calendar_month</i>月度分析
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab" aria-controls="yearly" aria-selected="false">
                    <i class="material-icons-round me-1" style="font-size: 18px; vertical-align: -4px;">calendar_today</i>年度分析
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="timeAnalysisTabContent">
            <!-- 周分析选项卡 -->
            <div class="tab-pane fade show active" id="weekly" role="tabpanel" aria-labelledby="weekly-tab">
                <!-- 周分析内容 -->
                <!-- 图表部分 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container" style="position: relative; height: 400px;">
                            <h5 class="mb-3"><i class="material-icons-round me-2" style="vertical-align: -4px;">calendar_view_week</i>按星期消费统计</h5>
                            {% if weekday_data %}
                            <canvas id="weekdayChart"></canvas>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="material-icons-round" style="font-size: 48px;">calendar_view_week</i>
                                <p class="mt-3">暂无按星期统计数据</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if weekday_data %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">图表显示选项</h6>
                                    <div>
                                        <button class="btn btn-sm btn-primary toggle-dataset" data-dataset="0">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">show_chart</i> 
                                            金额
                                        </button>
                                        <button class="btn btn-sm btn-warning toggle-dataset" data-dataset="1">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">analytics</i> 
                                            笔数
                                        </button>
                                        <button class="btn btn-sm btn-outline-success toggle-dataset" data-dataset="2">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">equalizer</i> 
                                            平均值
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- 按星期详情表格 -->
                <div class="mt-4">
                    <h5 class="mb-3"><i class="material-icons-round me-2" style="vertical-align: -4px;">table_chart</i>按星期消费详情</h5>
                    {% if weekly_stats|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>星期</th>
                                    <th>总支出 (元)</th>
                                    <th>交易笔数</th>
                                    <th>平均值 (元/笔)</th>
                                    <th>占比</th>
                                    <th>可视化</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total_expense = weekly_stats|sum(attribute='总额') %}
                                {% for day in weekly_stats %}
                                <tr>
                                    <td>{{ day.星期名 }}</td>
                                    <td>{{ "%.2f"|format(day.总额) }}</td>
                                    <td>{{ day.笔数 }}</td>
                                    <td>{{ "%.2f"|format(day.平均值) }}</td>
                                    <td>{{ "%.2f"|format(day.总额 / total_expense * 100) }}%</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-primary" role="progressbar" 
                                                data-width="{{ day.总额 / total_expense * 100 }}" 
                                                aria-valuenow="{{ day.总额 / total_expense * 100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-primary">
                                <tr>
                                    <th>总计</th>
                                    <th>{{ "%.2f"|format(weekly_stats|sum(attribute='总额')) }}</th>
                                    <th>{{ weekly_stats|sum(attribute='笔数') }}</th>
                                    <th>{{ "%.2f"|format(weekly_stats|sum(attribute='总额') / weekly_stats|sum(attribute='笔数')) }}</th>
                                    <th>100.00%</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- 按星期分析洞察 -->
                    <div class="mt-4">
                        <h5 class="mb-3"><i class="material-icons-round me-2" style="vertical-align: -4px;">lightbulb</i>时间消费洞察</h5>
                        
                        {% set max_day = weekly_stats|sort(attribute='总额')|last %}
                        {% set min_day = weekly_stats|sort(attribute='总额')|first %}
                        {% set max_day_count = weekly_stats|sort(attribute='笔数')|last %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-danger">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_upward</i>消费最高的星期</h5>
                                    <p>
                                        <strong>{{ max_day.星期名 }}</strong> 是消费金额最高的一天，
                                        总支出 <strong>{{ "%.2f"|format(max_day.总额) }}</strong> 元，
                                        占总支出的 <strong>{{ "%.2f"|format(max_day.总额 / total_expense * 100) }}%</strong>，
                                        共 {{ max_day.笔数 }} 笔交易，平均每笔 {{ "%.2f"|format(max_day.平均值) }} 元。
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-success">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_downward</i>消费最低的星期</h5>
                                    <p>
                                        <strong>{{ min_day.星期名 }}</strong> 是消费金额最低的一天，
                                        总支出 <strong>{{ "%.2f"|format(min_day.总额) }}</strong> 元，
                                        占总支出的 <strong>{{ "%.2f"|format(min_day.总额 / total_expense * 100) }}%</strong>，
                                        共 {{ min_day.笔数 }} 笔交易，平均每笔 {{ "%.2f"|format(min_day.平均值) }} 元。
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">shopping_cart</i>交易次数最多的星期</h5>
                                    <p>
                                        <strong>{{ max_day_count.星期名 }}</strong> 是交易笔数最多的一天，
                                        共 <strong>{{ max_day_count.笔数 }}</strong> 笔交易，
                                        总支出 {{ "%.2f"|format(max_day_count.总额) }} 元，
                                        平均每笔 {{ "%.2f"|format(max_day_count.平均值) }} 元。
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-warning">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">today</i>工作日与周末对比</h5>
                                    {% set weekdays = weekly_stats[:5] %}
                                    {% set weekends = weekly_stats[5:] %}
                                    {% set weekday_total = weekdays|sum(attribute='总额') %}
                                    {% set weekend_total = weekends|sum(attribute='总额') %}
                                    <p>
                                        工作日（周一至周五）总支出 <strong>{{ "%.2f"|format(weekday_total) }}</strong> 元，
                                        占总支出的 <strong>{{ "%.2f"|format(weekday_total / total_expense * 100) }}%</strong>。
                                        周末（周六、周日）总支出 <strong>{{ "%.2f"|format(weekend_total) }}</strong> 元，
                                        占总支出的 <strong>{{ "%.2f"|format(weekend_total / total_expense * 100) }}%</strong>。
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="material-icons-round" style="font-size: 48px;">table_chart</i>
                        <p class="mt-3">暂无按星期统计数据</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 月度分析选项卡 -->
            <div class="tab-pane fade" id="monthly" role="tabpanel" aria-labelledby="monthly-tab">
                <!-- 月份筛选 -->
                <div class="mb-4">
                    {% if year_filter %}
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="material-icons-round me-2" style="font-size: 24px;">filter_alt</i>
                        <div>
                            <strong>当前筛选:</strong> {{ year_filter }}年
                            <a href="{{ url_for('time_analysis') }}" class="btn btn-sm btn-outline-secondary ms-3">
                                <i class="material-icons-round" style="font-size: 18px; vertical-align: -4px;">close</i> 清除筛选
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- 月度图表 -->
                <div class="chart-container mb-4">
                    <h5 class="mb-3"><i class="material-icons-round me-2" style="vertical-align: -4px;">bar_chart</i>{% if year_filter %}{{ year_filter }}年{% endif %}月度收支趋势</h5>
                    {% if monthly_data %}
                    <div style="position: relative; height: 400px;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="material-icons-round" style="font-size: 48px;">bar_chart</i>
                        <p class="mt-3">暂无月度统计数据</p>
                    </div>
                    {% endif %}
                </div>

                {% if monthly_data %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">图表显示选项</h6>
                                    <div>
                                        <button class="btn btn-sm btn-success monthly-toggle-dataset" data-dataset="0">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">arrow_upward</i> 
                                            收入
                                        </button>
                                        <button class="btn btn-sm btn-danger monthly-toggle-dataset" data-dataset="1">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">arrow_downward</i> 
                                            支出
                                        </button>
                                        <button class="btn btn-sm btn-primary monthly-toggle-dataset" data-dataset="2">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">sync_alt</i> 
                                            净额
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- 月度数据表格 -->
                <div class="mt-4">
                    <h5 class="mb-3"><i class="material-icons-round me-2" style="vertical-align: -4px;">table_chart</i>月度收支详情</h5>
                    {% if monthly_stats|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>月份</th>
                                    <th>收入 (元)</th>
                                    <th>支出 (元)</th>
                                    <th>净收支 (元)</th>
                                    <th>收入占比</th>
                                    <th>支出占比</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for month_data in monthly_stats %}
                                <tr>
                                    <td>{{ month_data.月份 }}</td>
                                    <td class="text-success">{{ "%.2f"|format(month_data.收入) }}</td>
                                    <td class="text-danger">{{ "%.2f"|format(month_data.支出) }}</td>
                                    <td class="{% if month_data.净额 >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.2f"|format(month_data.净额) }}
                                    </td>
                                    <td>{{ "%.2f"|format(month_data.收入占比) }}%</td>
                                    <td>{{ "%.2f"|format(month_data.支出占比) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-primary">
                                <tr>
                                    <th>总计</th>
                                    <th class="text-success">{{ "%.2f"|format(monthly_stats|sum(attribute='收入')) }}</th>
                                    <th class="text-danger">{{ "%.2f"|format(monthly_stats|sum(attribute='支出')) }}</th>
                                    <th class="{% if monthly_stats|sum(attribute='净额') >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.2f"|format(monthly_stats|sum(attribute='净额')) }}
                                    </th>
                                    <th>100.00%</th>
                                    <th>100.00%</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- 月度统计分析 -->
                    <div class="mt-4">
                        <h5 class="mb-3"><i class="material-icons-round me-2" style="vertical-align: -4px;">lightbulb</i>{% if year_filter %}{{ year_filter }}年{% endif %}月度收支分析洞察</h5>
                        
                        {% set highest_income_month = monthly_stats|sort(attribute='收入')|last %}
                        {% set highest_expense_month = monthly_stats|sort(attribute='支出')|last %}
                        {% set lowest_income_month = monthly_stats|sort(attribute='收入')|first %}
                        {% set lowest_expense_month = monthly_stats|sort(attribute='支出')|first %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-success">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_upward</i>收入最高的月份</h5>
                                    <p>{{ highest_income_month.月份 }}月收入达到 <strong>{{ "%.2f"|format(highest_income_month.收入) }}</strong> 元，
                                    同期支出 {{ "%.2f"|format(highest_income_month.支出) }} 元，净收支 {{ "%.2f"|format(highest_income_month.净额) }} 元。</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-danger">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_upward</i>支出最高的月份</h5>
                                    <p>{{ highest_expense_month.月份 }}月支出达到 <strong>{{ "%.2f"|format(highest_expense_month.支出) }}</strong> 元，
                                    同期收入 {{ "%.2f"|format(highest_expense_month.收入) }} 元，净收支 {{ "%.2f"|format(highest_expense_month.净额) }} 元。</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-warning">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_downward</i>收入最低的月份</h5>
                                    <p>{{ lowest_income_month.月份 }}月收入仅为 <strong>{{ "%.2f"|format(lowest_income_month.收入) }}</strong> 元，
                                    同期支出 {{ "%.2f"|format(lowest_income_month.支出) }} 元，净收支 {{ "%.2f"|format(lowest_income_month.净额) }} 元。</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_downward</i>支出最低的月份</h5>
                                    <p>{{ lowest_expense_month.月份 }}月支出仅为 <strong>{{ "%.2f"|format(lowest_expense_month.支出) }}</strong> 元，
                                    同期收入 {{ "%.2f"|format(lowest_expense_month.收入) }} 元，净收支 {{ "%.2f"|format(lowest_expense_month.净额) }} 元。</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-primary mt-3">
                            <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">show_chart</i>月度收支趋势分析</h5>
                            <p>
                            {% set avg_income = monthly_stats|sum(attribute='收入') / monthly_stats|length %}
                            {% set avg_expense = monthly_stats|sum(attribute='支出') / monthly_stats|length %}
                            {% set avg_net = monthly_stats|sum(attribute='净额') / monthly_stats|length %}
                            
                            在分析期间，月均收入为 <strong>{{ "%.2f"|format(avg_income) }}</strong> 元，
                            月均支出为 <strong>{{ "%.2f"|format(avg_expense) }}</strong> 元，
                            月均净收支为 <strong>{{ "%.2f"|format(avg_net) }}</strong> 元。
                            
                            {% if monthly_stats|length > 1 %}
                            {% set first_month = monthly_stats|first %}
                            {% set last_month = monthly_stats|last %}
                            {% set income_change = (last_month.收入 - first_month.收入) / first_month.收入 * 100 if first_month.收入 != 0 else 0 %}
                            {% set expense_change = (last_month.支出 - first_month.支出) / first_month.支出 * 100 if first_month.支出 != 0 else 0 %}
                            
                            从 {{ first_month.月份 }} 到 {{ last_month.月份 }}，
                            收入{% if income_change > 0 %}增长了{% else %}下降了{% endif %} <strong>{{ "%.1f"|format(income_change)|replace('-', '') }}%</strong>，
                            支出{% if expense_change > 0 %}增长了{% else %}下降了{% endif %} <strong>{{ "%.1f"|format(expense_change)|replace('-', '') }}%</strong>。
                            {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="material-icons-round" style="font-size: 48px;">table_chart</i>
                        <p class="mt-3">暂无月度统计数据</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 年度分析选项卡 -->
            <div class="tab-pane fade" id="yearly" role="tabpanel" aria-labelledby="yearly-tab">
                <!-- 年度图表 -->
                <div class="chart-container mb-4">
                    <h5 class="mb-3"><i class="material-icons-round me-2" style="vertical-align: -4px;">bar_chart</i>年度收支趋势</h5>
                    {% if yearly_data %}
                    <div style="position: relative; height: 400px;">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="material-icons-round" style="font-size: 48px;">bar_chart</i>
                        <p class="mt-3">暂无年度统计数据</p>
                    </div>
                    {% endif %}
                </div>

                {% if yearly_data %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">图表显示选项</h6>
                                    <div>
                                        <button class="btn btn-sm btn-success yearly-toggle-dataset" data-dataset="0">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">arrow_upward</i> 
                                            收入
                                        </button>
                                        <button class="btn btn-sm btn-danger yearly-toggle-dataset" data-dataset="1">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">arrow_downward</i> 
                                            支出
                                        </button>
                                        <button class="btn btn-sm btn-primary yearly-toggle-dataset" data-dataset="2">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">sync_alt</i> 
                                            净额
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- 年度数据表格 -->
                <div class="mt-4">
                    <h5 class="mb-3"><i class="material-icons-round me-2" style="vertical-align: -4px;">table_chart</i>年度收支详情</h5>
                    {% if yearly_stats|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>年份</th>
                                    <th>收入 (元)</th>
                                    <th>支出 (元)</th>
                                    <th>净收支 (元)</th>
                                    <th>年增长率</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for year_data in yearly_stats %}
                                <tr>
                                    <td>{{ year_data.年份 }}</td>
                                    <td class="text-success">{{ "%.2f"|format(year_data.收入) }}</td>
                                    <td class="text-danger">{{ "%.2f"|format(year_data.支出) }}</td>
                                    <td class="{% if year_data.净额 >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.2f"|format(year_data.净额) }}
                                    </td>
                                    <td class="{% if year_data.增长率 >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        {% if year_data.增长率 != None %}
                                            {{ "%.2f"|format(year_data.增长率 * 100) }}%
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="switchToMonthlyTab('{{ year_data.年份 }}')">
                                            <i class="material-icons-round" style="font-size: 16px; vertical-align: -4px;">calendar_month</i>
                                            查看月度
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-primary">
                                <tr>
                                    <th>总计</th>
                                    <th class="text-success">{{ "%.2f"|format(yearly_stats|sum(attribute='收入')) }}</th>
                                    <th class="text-danger">{{ "%.2f"|format(yearly_stats|sum(attribute='支出')) }}</th>
                                    <th class="{% if yearly_stats|sum(attribute='净额') >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.2f"|format(yearly_stats|sum(attribute='净额')) }}
                                    </th>
                                    <th>-</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- 年度统计分析 -->
                    <div class="mt-4">
                        <h5 class="mb-3"><i class="material-icons-round me-2" style="vertical-align: -4px;">lightbulb</i>年度收支分析洞察</h5>
                        
                        {% set highest_income_year = yearly_stats|sort(attribute='收入')|last %}
                        {% set highest_expense_year = yearly_stats|sort(attribute='支出')|last %}
                        {% set lowest_income_year = yearly_stats|sort(attribute='收入')|first %}
                        {% set lowest_expense_year = yearly_stats|sort(attribute='支出')|first %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-success">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_upward</i>收入最高的年份</h5>
                                    <p>{{ highest_income_year.年份 }}年收入达到 <strong>{{ "%.2f"|format(highest_income_year.收入) }}</strong> 元，
                                    同期支出 {{ "%.2f"|format(highest_income_year.支出) }} 元，净收支 {{ "%.2f"|format(highest_income_year.净额) }} 元。</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-danger">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_upward</i>支出最高的年份</h5>
                                    <p>{{ highest_expense_year.年份 }}年支出达到 <strong>{{ "%.2f"|format(highest_expense_year.支出) }}</strong> 元，
                                    同期收入 {{ "%.2f"|format(highest_expense_year.收入) }} 元，净收支 {{ "%.2f"|format(highest_expense_year.净额) }} 元。</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-warning">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_downward</i>收入最低的年份</h5>
                                    <p>{{ lowest_income_year.年份 }}年收入仅为 <strong>{{ "%.2f"|format(lowest_income_year.收入) }}</strong> 元，
                                    同期支出 {{ "%.2f"|format(lowest_income_year.支出) }} 元，净收支 {{ "%.2f"|format(lowest_income_year.净额) }} 元。</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">arrow_downward</i>支出最低的年份</h5>
                                    <p>{{ lowest_expense_year.年份 }}年支出仅为 <strong>{{ "%.2f"|format(lowest_expense_year.支出) }}</strong> 元，
                                    同期收入 {{ "%.2f"|format(lowest_expense_year.收入) }} 元，净收支 {{ "%.2f"|format(lowest_expense_year.净额) }} 元。</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-primary mt-3">
                            <h5><i class="material-icons-round me-2" style="vertical-align: -4px;">show_chart</i>年度收支趋势分析</h5>
                            <p>
                            {% set avg_income = yearly_stats|sum(attribute='收入') / yearly_stats|length %}
                            {% set avg_expense = yearly_stats|sum(attribute='支出') / yearly_stats|length %}
                            {% set avg_net = yearly_stats|sum(attribute='净额') / yearly_stats|length %}
                            
                            在分析期间，年均收入为 <strong>{{ "%.2f"|format(avg_income) }}</strong> 元，
                            年均支出为 <strong>{{ "%.2f"|format(avg_expense) }}</strong> 元，
                            年均净收支为 <strong>{{ "%.2f"|format(avg_net) }}</strong> 元。
                            
                            {% if yearly_stats|length > 1 %}
                            {% set first_year = yearly_stats|first %}
                            {% set last_year = yearly_stats|last %}
                            {% set income_change = (last_year.收入 - first_year.收入) / first_year.收入 * 100 if first_year.收入 != 0 else 0 %}
                            {% set expense_change = (last_year.支出 - first_year.支出) / first_year.支出 * 100 if first_year.支出 != 0 else 0 %}
                            
                            从 {{ first_year.年份 }} 到 {{ last_year.年份 }}，
                            收入{% if income_change > 0 %}增长了{% else %}下降了{% endif %} <strong>{{ "%.1f"|format(income_change)|replace('-', '') }}%</strong>，
                            支出{% if expense_change > 0 %}增长了{% else %}下降了{% endif %} <strong>{{ "%.1f"|format(expense_change)|replace('-', '') }}%</strong>。
                            {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="material-icons-round" style="font-size: 48px;">table_chart</i>
                        <p class="mt-3">暂无年度统计数据</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表数据 -->
{% endblock %}

{% block scripts %}
{{ super() }}
    data-count="{{ weekday_data.count|tojson }}"
{% endblock %} 