{% macro icon(name, size="md", color_class="", extra_classes="") %}
<i data-lucide="{{ name }}" class="lucide-icon
  {%- if size == "sm" %} icon-sm{% elif size == "md" %} icon-md{% elif size == "lg" %} icon-lg{% elif size == "xl" %} icon-xl{% elif size == "xxl" %} icon-xxl{% endif %}
  {%- if color_class %} {{ color_class }}{% endif %}
  {%- if extra_classes %} {{ extra_classes }}{% endif %}"></i><span class="icon-text position-absolute" style="clip: rect(0,0,0,0); width: 1px; height: 1px; overflow: hidden;">{{ name }}</span>
{% endmacro %}

{% macro page_header(title, subtitle="", icon_name="") %}
<!-- 统一页头组件 - Bootstrap 重构版 -->
<div class="bg-white border-bottom shadow-sm p-4 mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                {% if icon_name %}
                <div class="me-3 bg-primary bg-opacity-10 rounded-3 d-flex align-items-center justify-content-center" style="width: 3rem; height: 3rem;">
                    {{ icon(icon_name, "lg", "text-primary") }}
                </div>
                {% endif %}
                <div>
                    <h1 class="fw-bold mb-1 fs-2">{{ title }}</h1>
                    {% if subtitle %}
                    <p class="text-muted mb-0">{{ subtitle }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{% macro card(title="", icon_name="", header_class="", body_class="") %}
<div class="card h-100 shadow-sm border-0">
  {% if title %}
  <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between {{ header_class }}">
    <div class="d-flex align-items-center">
      {% if icon_name %}
      <div class="me-2 bg-light rounded-2 d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem;">
        {{ icon(icon_name, "sm", "text-primary") }}
      </div>
      {% endif %}
      <h6 class="card-title fw-bold mb-0">{{ title }}</h6>
    </div>
    {% if caller().actions is defined %}
      <div class="card-actions">
        {{ caller().actions }}
      </div>
    {% endif %}
  </div>
  {% endif %}
  <div class="card-body {{ body_class if body_class else 'p-3' }}">
    {{ caller() }}
  </div>
</div>
{% endmacro %}







{% macro stat_card(icon_name, value, label, icon_color="primary", value_color="", value_id="", change_text="", change_id="", trend="", trend_value="", clickable=false, onclick="") %}
<div class="card h-100 shadow-sm border-0 stat-card {% if clickable %}cursor-pointer{% endif %}"
     {% if clickable and onclick %}onclick="{{ onclick }}"{% endif %}>
  <div class="card-body p-4 d-flex align-items-center">
    <div class="me-3 bg-{{ icon_color }} rounded-3 d-flex align-items-center justify-content-center flex-shrink-0" style="width: 3rem; height: 3rem;">
      {{ icon(icon_name, "md", "text-white") }}
    </div>
    <div class="flex-grow-1 min-width-0">
      <div class="fs-4 fw-bold mb-1{% if value_color %} text-{{ value_color }}{% endif %}"{% if value_id %} id="{{ value_id }}"{% endif %}>{{ value }}</div>
      <div class="text-muted small mb-1">{{ label }}</div>

      {% if trend and trend_value %}
      <div class="badge bg-{% if trend == 'up' %}success{% elif trend == 'down' %}danger{% else %}secondary{% endif %} bg-opacity-10 text-{% if trend == 'up' %}success{% elif trend == 'down' %}danger{% else %}secondary{% endif %}"{% if change_id %} id="{{ change_id }}"{% endif %}>
        {{ icon("trending-" + trend if trend in ['up', 'down'] else "minus", "sm", "me-1") }}
        {{ trend_value }}
      </div>
      {% elif change_text %}
      <div class="badge bg-light text-dark"{% if change_id %} id="{{ change_id }}"{% endif %}>{{ change_text }}</div>
      {% endif %}
    </div>
    {% if clickable %}
    <div class="ms-2 text-muted">
      {{ icon("chevron-right", "sm") }}
    </div>
    {% endif %}
  </div>
</div>
{% endmacro %}



{% macro chart_container(title, chart_id, height="250px", icon_name="trending-up", show_toolbar=false, fullscreen=false, export_enabled=false) %}
<div class="card border-0 shadow-sm h-100">
  <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <div class="me-2 bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem;">
        {{ icon(icon_name, "sm", "text-primary") }}
      </div>
      <h6 class="mb-0 fw-bold">{{ title }}</h6>
    </div>
    {% if show_toolbar %}
    <div class="chart-actions d-flex gap-1">
      {% if export_enabled %}
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          {{ icon("download", "sm") }}
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" data-chart-export="png" data-chart="{{ chart_id }}">
            {{ icon("image", "sm", "me-2") }}PNG图片
          </a></li>
          <li><a class="dropdown-item" href="#" data-chart-export="svg" data-chart="{{ chart_id }}">
            {{ icon("file-image", "sm", "me-2") }}SVG矢量
          </a></li>
          <li><a class="dropdown-item" href="#" data-chart-export="pdf" data-chart="{{ chart_id }}">
            {{ icon("file-text", "sm", "me-2") }}PDF文档
          </a></li>
        </ul>
      </div>
      {% endif %}
      {% if fullscreen %}
      <button class="btn btn-sm btn-outline-secondary" data-chart-fullscreen="{{ chart_id }}">
        {{ icon("maximize", "sm") }}
      </button>
      {% endif %}
      <button class="btn btn-sm btn-outline-secondary" data-chart-refresh="{{ chart_id }}">
        {{ icon("refresh-cw", "sm") }}
      </button>
    </div>
    {% endif %}
  </div>
  <div class="card-body">
    <div class="position-relative chart-container" {% if height %}style="height: {{ height }};"{% endif %}>
      <div id="{{ chart_id }}" class="w-100 h-100"></div>
      <!-- 加载状态 -->
      <div id="{{ chart_id }}-loading" class="chart-loading d-none">
        {{ loading_state("加载图表数据中...", "sm", "primary") }}
      </div>
    </div>
  </div>
</div>
{% endmacro %}



{# ==================== 导航链接组件宏 ==================== #}

{% macro nav_link(endpoint, label, icon_name, extra_classes="") %}
<li class="nav-item">
  <a class="nav-link d-flex align-items-center rounded px-3 py-2 text-decoration-none {% if request.endpoint == endpoint or (request.blueprint and endpoint.split('.')[0] == request.blueprint) %}active{% endif %} {{ extra_classes }}" href="{{ url_for(endpoint) }}">
    {{ icon(icon_name, "sm", "me-2") }}
    <span>{{ label }}</span>
  </a>
</li>
{% endmacro %}

{% macro file_uploader(id="file-uploader", accept_types=".xlsx,.xls,.csv", instructions="") %}
<div class="text-center py-4">
    {% if instructions %}
    <h5 class="fw-bold mb-3 text-start">{{ instructions }}</h5>
    {% else %}
    <h5 class="fw-bold mb-3 text-start">如何获得银行账单文件：</h5>
    <ol class="text-muted mb-4 text-start">
        <li>打开手机银行</li>
        <li>找到打印流水</li>
        <li>输入您的邮箱</li>
        <li>将解压后的文件上传</li>
    </ol>
    {% endif %}
    
    <div class="border border-2 border-dashed rounded-3 p-5 bg-light bg-opacity-50 position-relative file-drop-zone" 
         id="{{ id ~ '-drop-zone' }}" 
         style="transition: all 0.2s ease; cursor: pointer;">
        <div class="mb-3">
            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" 
                 style="width: 4rem; height: 4rem;">
                {{ icon("upload-cloud", "xl", "text-primary") }}
            </div>
        </div>
        
        <h5 class="mb-3">拖拽文件到此处或点击上传</h5>
        <p class="text-muted mb-3">支持 Excel (.xlsx, .xls) 和 CSV 文件</p>
        
        <input type="file" id="{{ id ~ '-input' }}" class="d-none" accept="{{ accept_types }}" multiple>
        <button type="button" class="btn btn-primary" data-file-input="{{ id ~ '-input' }}">
            {{ icon("plus", "sm", "me-1") }} 选择文件
        </button>
    </div>
    
    <!-- 处理状态指示器 -->
    <div class="mt-4 d-none processing-indicator" id="{{ id ~ '-processing' }}">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-4">
                <!-- 旋转加载器 -->
                <div class="processing-spinner mb-3">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">处理中...</span>
                    </div>
                </div>

                <!-- 当前阶段描述 -->
                <h6 class="processing-stage mb-2" id="{{ id ~ '-processing-stage' }}">准备处理文件...</h6>

                <!-- 文件信息 -->
                <p class="text-muted mb-2 processing-file-info" id="{{ id ~ '-processing-file-info' }}"></p>

                <!-- 时间预估 -->
                <small class="text-muted processing-time-estimate" id="{{ id ~ '-processing-time-estimate' }}"></small>

                <!-- 阶段指示器 -->
                <div class="stage-indicators mt-3 d-flex justify-content-center gap-3">
                    <div class="stage-dot" data-stage="upload">
                        <small>上传</small>
                    </div>
                    <div class="stage-dot" data-stage="validate">
                        <small>验证</small>
                    </div>
                    <div class="stage-dot" data-stage="extract">
                        <small>提取</small>
                    </div>
                    <div class="stage-dot" data-stage="save">
                        <small>保存</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{# ==================== 商户卡片组件宏 ==================== #}

{% macro merchant_card(merchant, show_detail_btn=true, card_class="") %}
<div class="merchant-card card border-0 shadow-sm mb-3 h-100 {{ card_class }}" style="transition: all 0.2s ease;">
  <div class="card-body p-3">
    <div class="d-flex align-items-center">
      <div class="me-3 flex-shrink-0">
        <div class="merchant-icon bg-{{ merchant.category_color or 'primary' }} bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 2.5rem; height: 2.5rem;">
          {{ icon(merchant.category_icon or 'store', "sm", "text-" + (merchant.category_color or 'primary')) }}
        </div>
      </div>
      <div class="flex-grow-1 min-width-0">
        <h6 class="merchant-name mb-1 fw-semibold text-truncate">{{ merchant.merchant }}</h6>
        <div class="merchant-meta small text-muted mb-2">
          <span class="badge bg-light text-dark me-1">{{ merchant.category or '其他' }}</span>
          <span>{{ merchant.transaction_count }}次交易</span>
        </div>
        <!-- 评分进度条 -->
        <div class="score-progress mb-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="small text-muted">评分</span>
            <span class="small fw-semibold">{{ "%.1f"|format(merchant.total_score) }}分</span>
          </div>
          <div class="progress" style="height: 4px;">
            <div class="progress-bar bg-{{ merchant.score_color or 'primary' }}" style="width: {{ (merchant.total_score or 0) }}%"></div>
          </div>
        </div>
      </div>
      <div class="text-end flex-shrink-0">
        <div class="merchant-amount fw-bold text-primary">¥{{ "%.2f"|format(merchant.avg_amount) }}</div>
        <div class="merchant-interval small text-muted">{{ merchant.avg_interval }}天间隔</div>
        {% if show_detail_btn %}
        <button class="btn btn-sm btn-outline-primary mt-2" onclick="expenseAnalysisPage.showMerchantDetail('{{ merchant.merchant }}')">
          {{ icon("eye", "sm", "me-1") }}详情
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{# ==================== 新增组件宏 ==================== #}

{% macro data_card(title, value, icon_name="", trend="", trend_value="", color="primary", size="md", clickable=false, onclick="") %}
<!-- 数据展示卡片组件 -->
<div class="card h-100 shadow-sm border-0 {% if clickable %}cursor-pointer{% endif %} data-card"
     {% if clickable and onclick %}onclick="{{ onclick }}"{% endif %}>
  <div class="card-body p-4 d-flex align-items-center">
    {% if icon_name %}
    <div class="me-3 bg-{{ color }} bg-opacity-10 rounded-3 d-flex align-items-center justify-content-center flex-shrink-0"
         style="width: {% if size == 'sm' %}2.5rem; height: 2.5rem{% elif size == 'lg' %}4rem; height: 4rem{% else %}3rem; height: 3rem{% endif %};">
      {{ icon(icon_name, size, "text-" + color) }}
    </div>
    {% endif %}
    <div class="flex-grow-1 min-width-0">
      <div class="fs-{% if size == 'sm' %}5{% elif size == 'lg' %}2{% else %}4{% endif %} fw-bold mb-1 text-{{ color }}">{{ value }}</div>
      <div class="text-muted small mb-1">{{ title }}</div>
      {% if trend and trend_value %}
      <div class="badge bg-{% if trend == 'up' %}success{% elif trend == 'down' %}danger{% else %}secondary{% endif %} bg-opacity-10 text-{% if trend == 'up' %}success{% elif trend == 'down' %}danger{% else %}secondary{% endif %}">
        {{ icon("trending-" + trend if trend in ['up', 'down'] else "minus", "sm", "me-1") }}
        {{ trend_value }}
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endmacro %}

{% macro filter_bar(filters=[], search_placeholder="搜索...") %}
<!-- 筛选条件栏组件 -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <!-- 搜索框 -->
      <div class="col-md-4">
        <label class="form-label small fw-semibold text-muted">搜索</label>
        <div class="input-group">
          <span class="input-group-text bg-light border-end-0">
            {{ icon("search", "sm", "text-muted") }}
          </span>
          <input type="text" class="form-control border-start-0 bg-light"
                 placeholder="{{ search_placeholder }}" id="search-input">
        </div>
      </div>

      <!-- 动态筛选器 -->
      {% for filter in filters %}
      <div class="col-md-{% if filters|length <= 2 %}4{% else %}3{% endif %}">
        <label class="form-label small fw-semibold text-muted">{{ filter.label }}</label>
        {% if filter.type == 'select' %}
        <select class="form-select" id="{{ filter.id }}">
          <option value="">全部</option>
          {% for option in filter.options %}
          <option value="{{ option.value }}">{{ option.label }}</option>
          {% endfor %}
        </select>
        {% elif filter.type == 'date' %}
        <input type="date" class="form-control" id="{{ filter.id }}">
        {% elif filter.type == 'daterange' %}
        <div class="input-group">
          <input type="date" class="form-control" id="{{ filter.id }}-start" placeholder="开始日期">
          <span class="input-group-text">至</span>
          <input type="date" class="form-control" id="{{ filter.id }}-end" placeholder="结束日期">
        </div>
        {% endif %}
      </div>
      {% endfor %}

      <!-- 操作按钮 -->
      <div class="col-md-{% if filters|length <= 2 %}4{% else %}3{% endif %}">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-primary" id="apply-filters">
            {{ icon("filter", "sm", "me-1") }}筛选
          </button>
          <button type="button" class="btn btn-outline-secondary" id="reset-filters">
            {{ icon("refresh-cw", "sm", "me-1") }}重置
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% macro loading_state(message="加载中...", size="md", theme="primary", overlay=false) %}
<!-- 加载状态组件 -->
<div class="text-center py-4 {% if overlay %}loading-overlay{% endif %}">
  <div class="{% if size == 'sm' %}mb-2{% elif size == 'lg' %}mb-4{% else %}mb-3{% endif %}">
    <div class="spinner-border text-{{ theme }} {% if size == 'sm' %}spinner-border-sm{% elif size == 'lg' %}spinner-border-lg{% endif %}" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
  </div>
  <p class="{% if size == 'sm' %}small{% elif size == 'lg' %}fs-5{% endif %} text-{% if theme == 'light' %}white{% else %}muted{% endif %}">{{ message }}</p>
</div>
{% endmacro %}

{% macro breadcrumb(items=[]) %}
<!-- 面包屑导航组件 -->
<nav aria-label="面包屑导航" class="mb-4">
  <ol class="breadcrumb">
    {% for item in items %}
    <li class="breadcrumb-item {% if loop.last %}active{% endif %}">
      {% if not loop.last and item.url %}
      <a href="{{ item.url }}" class="text-decoration-none">
        {% if loop.first %}{{ icon("home", "sm", "me-1") }}{% endif %}
        {{ item.label }}
      </a>
      {% else %}
      <span>{{ item.label }}</span>
      {% endif %}
    </li>
    {% endfor %}
  </ol>
</nav>
{% endmacro %}

{% macro modal(id, title, size="", centered=true, scrollable=false, static_backdrop=true) %}
<!-- 模态框组件 -->
<div class="modal fade" id="{{ id }}" tabindex="-1" aria-labelledby="{{ id }}-label" aria-hidden="true"
     {% if static_backdrop %}data-bs-backdrop="static" data-bs-keyboard="false"{% endif %}>
  <div class="modal-dialog {% if size %}modal-{{ size }}{% endif %} {% if centered %}modal-dialog-centered{% endif %} {% if scrollable %}modal-dialog-scrollable{% endif %}">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="{{ id }}-label">{{ title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        {{ caller() }}
      </div>
      {% if caller().footer is defined %}
      <div class="modal-footer">
        {{ caller().footer }}
      </div>
      {% else %}
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" id="{{ id }}-confirm">确认</button>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endmacro %}

{% macro alert_banner(message, type="info", dismissible=true, icon_name="", extra_classes="") %}
<!-- 通知横幅组件 -->
<div class="alert alert-{{ type }} {% if dismissible %}alert-dismissible fade show{% endif %} {{ extra_classes }}">
  {% if icon_name %}
    {{ icon(icon_name, "sm", "me-2") }}
  {% elif type == 'success' %}
    {{ icon("check-circle", "sm", "me-2") }}
  {% elif type == 'danger' %}
    {{ icon("x-circle", "sm", "me-2") }}
  {% elif type == 'warning' %}
    {{ icon("alert-triangle", "sm", "me-2") }}
  {% else %}
    {{ icon("info", "sm", "me-2") }}
  {% endif %}
  {{ message }}
  {% if dismissible %}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="关闭"></button>
  {% endif %}
</div>
{% endmacro %}

{% macro no_data_guide(page_type="analysis") %}
<!-- 无数据状态引导 -->
<div class="no-data-overlay">
    <div class="no-data-content">
        <div class="mb-4">
            {{ icon("database-x", "xxl", "text-muted") }}
        </div>
        <h3 class="mb-3">欢迎使用 AiBookkeeping</h3>
        <p class="text-muted mb-4">
            {% if page_type == "analysis" %}
            导入财务数据后，您将看到详细的分析报告。
            {% else %}
            导入数据后，系统将提供智能分类建议。
            {% endif %}
        </p>
        <a href="{{ url_for('settings_bp.settings_index') }}" class="btn btn-primary btn-lg">
            {{ icon("upload", "sm", "me-2") }}
            立即导入数据
        </a>
    </div>
</div>
{% endmacro %}