{% macro icon(name, size="md", color_class="", extra_classes="") %}
<i data-lucide="{{ name }}" class="lucide-icon
  {%- if size == "sm" %} icon-sm{% elif size == "md" %} icon-md{% elif size == "lg" %} icon-lg{% elif size == "xl" %} icon-xl{% elif size == "xxl" %} icon-xxl{% endif %}
  {%- if color_class %} {{ color_class }}{% endif %}
  {%- if extra_classes %} {{ extra_classes }}{% endif %}"></i><span class="icon-text position-absolute" style="clip: rect(0,0,0,0); width: 1px; height: 1px; overflow: hidden;">{{ name }}</span>
{% endmacro %}

{% macro page_header(title, subtitle="", icon_name="") %}
<!-- 统一页头组件 -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                {% if icon_name %}
                <div class="icon-circle me-3 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center icon-lg">
                    {{ icon(icon_name, "lg", "text-primary") }}
                </div>
                {% endif %}
                <div>
                    <h1 class="fw-bold mb-1">{{ title }}</h1>
                    {% if subtitle %}
                    <p class="text-muted mb-0">{{ subtitle }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{% macro card(title="", icon_name="", header_class="", body_class="p-6") %}
<div class="card h-100 dashboard-card">
  {% if title %}
  <div class="card-header d-flex align-items-center justify-content-between {% if header_class %}{{ header_class }}{% endif %}">
    <div class="d-flex align-items-center">
      {% if icon_name %}
      <div class="icon-circle me-2 bg-light d-flex align-items-center justify-content-center">
        {{ icon(icon_name, "sm", "text-primary") }}
      </div>
      {% endif %}
      <h6 class="card-title fw-bold mb-0">{{ title }}</h6>
    </div>
    {% if caller().actions is defined %}
      <div class="card-actions">
        {{ caller().actions }}
      </div>
    {% endif %}
  </div>
  {% endif %}
  <div class="card-body {{ body_class }}">
    {{ caller() }}
  </div>
</div>
{% endmacro %}

{% macro data_table(id, headers, title="数据明细", total=0, filtered=0, no_data_message="没有找到匹配的记录") %}
<div class="card border-0 h-100">
  <div class="card-header d-flex justify-content-between align-items-center bg-white py-3">
    <div class="d-flex align-items-center">
      <div class="icon-circle me-2 bg-light d-flex align-items-center justify-content-center">
        {{ icon("receipt", "sm", "text-primary") }}
      </div>
      <h6 class="card-title fw-bold mb-0">{{ title }}</h6>
    </div>
    {% if total > 0 %}
    <div class="d-flex align-items-center">
      <div class="table-stats d-flex align-items-center">
        <span class="badge rounded-pill bg-primary" id="{{ id ~ '-filtered-count' }}">{{ filtered }}</span>
        <span class="mx-1">/</span>
        <span class="badge rounded-pill bg-light text-dark">{{ total }}</span>
      </div>
    </div>
    {% endif %}
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 table-striped transactions-table" id="{{ id }}">
        <thead class="table-light">
          <tr>
            {% for header in headers %}
            <th>{{ header }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody id="{{ id ~ '-body' }}">
          <!-- 表格内容将通过JavaScript动态填充 -->
        </tbody>
      </table>
    </div>
    
    <!-- 分页控件 -->
    <div id="{{ id ~ '-pagination-container' }}" class="pagination-container p-3 border-top">
      <ul class="pagination pagination-sm justify-content-center mb-0" id="{{ id ~ '-pagination' }}">
        <!-- 分页按钮将通过JavaScript动态填充 -->
      </ul>
    </div>
    
    <!-- 无数据提示 -->
    <div id="{{ id ~ '-no-data' }}" class="no-data-container d-flex flex-column align-items-center justify-content-center py-5">
      {{ icon("search-x", "xxl", "text-muted mb-3") }}
      <p class="mb-3 text-muted">{{ no_data_message }}</p>
      <button id="{{ id ~ '-reset-all' }}" class="btn btn-sm btn-outline-primary">
        {{ icon("refresh-cw", "sm", "", "me-1") }}
        <span>重置筛选条件</span>
      </button>
    </div>
  </div>
</div>
{% endmacro %}





{% macro stat_card(icon_name, value, label, icon_color="primary", value_color="", value_id="", change_text="", change_id="") %}
<div class="stat-card">
  <div class="stat-card-body">
    <div class="stat-icon bg-{{ icon_color }}">
      {{ icon(icon_name, "md", "text-white") }}
    </div>
    <div class="stat-content">
      <div class="stat-value{% if value_color %} text-{{ value_color }}{% endif %}"{% if value_id %} id="{{ value_id }}"{% endif %}>{{ value }}</div>
      <div class="stat-label">{{ label }}</div>
      {% if change_text %}
      <div class="stat-change"{% if change_id %} id="{{ change_id }}"{% endif %}>{{ change_text }}</div>
      {% endif %}
    </div>
  </div>
</div>
{% endmacro %}



{% macro chart_container(title, chart_id, height="250px", icon_name="trending-up") %}
<div class="card border-0 shadow-sm h-100">
  <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <div class="icon-circle me-2 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem; border-radius: 50%;">
        {{ icon(icon_name, "sm", "text-primary") }}
      </div>
      <h6 class="mb-0 fw-bold">{{ title }}</h6>
    </div>
    <div class="chart-actions">
      <!-- 可选的图表操作按钮 -->
    </div>
  </div>
  <div class="card-body">
    <div class="chart-container" {% if height %}style="position: relative; height: {{ height }};"{% endif %}>
      <canvas id="{{ chart_id }}" class="chart-canvas"></canvas>
    </div>
  </div>
</div>
{% endmacro %}



{# ==================== 导航链接组件宏 ==================== #}

{% macro nav_link(endpoint, label, icon_name, extra_classes="") %}
<li class="nav-item mb-1">
  <a class="nav-link rounded {% if request.endpoint == endpoint or (request.blueprint and endpoint.split('.')[0] == request.blueprint) %}active{% endif %} {{ extra_classes }}" href="{{ url_for(endpoint) }}">
    <div class="nav-icon-round d-flex align-items-center">
      {{ icon(icon_name, "sm", "", "me-3") }}
      <span>{{ label }}</span>
    </div>
  </a>
</li>
{% endmacro %}

{% macro file_uploader(id="file-uploader", accept_types=".xlsx,.xls,.csv", instructions="") %}
<div class="text-center py-4">
    {% if instructions %}
    <h5 class="fw-bold mb-3 text-start">{{ instructions }}</h5>
    {% else %}
    <h5 class="fw-bold mb-3 text-start">如何获得银行账单文件：</h5>
    <ol class="text-muted mb-4 text-start">
        <li>打开手机银行</li>
        <li>找到打印流水</li>
        <li>输入您的邮箱</li>
        <li>将解压后的文件上传</li>
    </ol>
    {% endif %}
    
    <div class="upload-container" id="{{ id ~ '-container' }}">
        <div class="drop-zone" id="{{ id ~ '-drop-zone' }}">
            <div class="mb-3">
                <div class="upload-icon-wrapper d-inline-flex align-items-center justify-content-center bg-primary-light rounded-circle">
                    {{ icon("upload", "xl", "text-primary-custom") }}
                </div>
            </div>

            <div class="drop-zone-content">
                {{ icon("upload-cloud", "xxl", "text-muted mb-3") }}
                <h5>拖拽文件到此处或点击上传</h5>
                <p class="text-muted">支持 Excel (.xlsx, .xls) 和 CSV 文件</p>
                <input type="file" id="{{ id ~ '-input' }}" class="d-none" accept="{{ accept_types }}" multiple>
                <button type="button" class="btn btn-primary" data-file-input="{{ id ~ '-input' }}">
                    {{ icon("plus", "sm", "", "me-1") }} 选择文件
                </button>
            </div>
        </div>
    </div>
    
    <!-- 详细进度条容器 -->
    <div class="upload-progress-container" id="{{ id ~ '-progress' }}" style="display: none;">
        <div class="progress-wrapper">
            <div class="progress mb-3" style="height: 1.5rem;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     id="{{ id ~ '-progress-bar' }}" 
                     role="progressbar" 
                     style="width: 0%" 
                     aria-valuenow="0" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                    <span class="progress-text" id="{{ id ~ '-progress-text' }}">0%</span>
                </div>
            </div>
            <div class="upload-status-text mb-2" id="{{ id ~ '-status-text' }}">
                {{ icon("loader-2", "sm", "me-2", "animate-spin") }}
                准备上传...
            </div>
            <div class="upload-file-info mb-2" id="{{ id ~ '-file-info' }}"></div>
            <div class="upload-time-estimate text-muted small" id="{{ id ~ '-time-estimate' }}"></div>
        </div>
    </div>
</div>
{% endmacro %}