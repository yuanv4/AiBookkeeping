{% macro icon(name, size="md", color_class="", extra_classes="") %}
<i data-lucide="{{ name }}" class="lucide-icon
  {%- if size == "sm" %} icon-sm{% elif size == "md" %} icon-md{% elif size == "lg" %} icon-lg{% elif size == "xl" %} icon-xl{% elif size == "xxl" %} icon-xxl{% endif %}
  {%- if color_class %} {{ color_class }}{% endif %}
  {%- if extra_classes %} {{ extra_classes }}{% endif %}"></i><span class="icon-text position-absolute" style="clip: rect(0,0,0,0); width: 1px; height: 1px; overflow: hidden;">{{ name }}</span>
{% endmacro %}

{% macro card(title="", icon_name="", header_class="", body_class="") %}
<div class="card h-100 shadow-sm border-0">
  {% if title %}
  <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between {{ header_class }}">
    <div class="d-flex align-items-center">
      {% if icon_name %}
      <div class="me-2 bg-light rounded-2 d-flex align-items-center justify-content-center" style="width: 2rem; height: 2rem;">
        {{ icon(icon_name, "sm", "text-primary") }}
      </div>
      {% endif %}
      <h6 class="card-title fw-bold mb-0">{{ title }}</h6>
    </div>
    {% if caller().actions is defined %}
      <div class="card-actions">
        {{ caller().actions }}
      </div>
    {% endif %}
  </div>
  {% endif %}
  <div class="card-body {{ body_class if body_class else 'p-3' }}">
    {{ caller() }}
  </div>
</div>
{% endmacro %}















{# ==================== 导航链接组件宏 ==================== #}

{% macro nav_link(endpoint, label, icon_name, extra_classes="") %}
<li class="nav-item">
  <a class="nav-link d-flex align-items-center rounded px-3 py-2 text-decoration-none {% if request.endpoint == endpoint or (request.blueprint and endpoint.split('.')[0] == request.blueprint) %}active{% endif %} {{ extra_classes }}" href="{{ url_for(endpoint) }}">
    {{ icon(icon_name, "sm", "me-2") }}
    <span>{{ label }}</span>
  </a>
</li>
{% endmacro %}

{% macro file_uploader(id="file-uploader", accept_types=".xlsx,.xls,.csv") %}
<div class="text-center py-4">
    <div class="border border-2 border-dashed rounded-3 p-5 bg-light bg-opacity-50 position-relative file-drop-zone" 
         id="{{ id ~ '-drop-zone' }}" 
         style="transition: all 0.2s ease; cursor: pointer;">
        <div class="mb-3">
            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" 
                 style="width: 4rem; height: 4rem;">
                {{ icon("upload-cloud", "xl", "text-primary") }}
            </div>
        </div>
        
        <h5 class="mb-3">拖拽文件到此处或点击上传</h5>
        <p class="text-muted mb-3">支持 Excel (.xlsx, .xls) 和 CSV 文件</p>
        
        <input type="file" id="{{ id ~ '-input' }}" class="d-none" accept="{{ accept_types }}" multiple>
        <button type="button" class="btn btn-primary" data-file-input="{{ id ~ '-input' }}">
            {{ icon("plus", "sm", "me-1") }} 选择文件
        </button>
    </div>
    
    <!-- 处理状态指示器 -->
    <div class="mt-4 d-none processing-indicator" id="{{ id ~ '-processing' }}">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-4">
                <!-- 旋转加载器 -->
                <div class="processing-spinner mb-3">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">处理中...</span>
                    </div>
                </div>

                <!-- 当前阶段描述 -->
                <h6 class="processing-stage mb-2" id="{{ id ~ '-processing-stage' }}">准备处理文件...</h6>

                <!-- 文件信息 -->
                <p class="text-muted mb-2 processing-file-info" id="{{ id ~ '-processing-file-info' }}"></p>

                <!-- 时间预估 -->
                <small class="text-muted processing-time-estimate" id="{{ id ~ '-processing-time-estimate' }}"></small>

                <!-- 阶段指示器 -->
                <div class="stage-indicators mt-3 d-flex justify-content-center gap-3">
                    <div class="stage-dot" data-stage="upload">
                        <small>上传</small>
                    </div>
                    <div class="stage-dot" data-stage="validate">
                        <small>验证</small>
                    </div>
                    <div class="stage-dot" data-stage="extract">
                        <small>提取</small>
                    </div>
                    <div class="stage-dot" data-stage="save">
                        <small>保存</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}



{# ==================== 新增组件宏 ==================== #}

{% macro data_card(title, value, icon_name="", trend="", trend_value="", color="primary", size="md", clickable=false, onclick="") %}
<!-- 数据展示卡片组件 -->
<div class="card h-100 shadow-sm border-0 {% if clickable %}cursor-pointer{% endif %} data-card"
     {% if clickable and onclick %}onclick="{{ onclick }}"{% endif %}>
  <div class="card-body p-4 d-flex align-items-center">
    {% if icon_name %}
    <div class="me-3 bg-{{ color }} bg-opacity-10 rounded-3 d-flex align-items-center justify-content-center flex-shrink-0"
         style="width: {% if size == 'sm' %}2.5rem; height: 2.5rem{% elif size == 'lg' %}4rem; height: 4rem{% else %}3rem; height: 3rem{% endif %};">
      {{ icon(icon_name, size, "text-" + color) }}
    </div>
    {% endif %}
    <div class="flex-grow-1 min-width-0">
      <div class="fs-{% if size == 'sm' %}5{% elif size == 'lg' %}2{% else %}4{% endif %} fw-bold mb-1 text-{{ color }}">{{ value }}</div>
      <div class="text-muted small mb-1">{{ title }}</div>
      {% if trend and trend_value %}
      <div class="badge bg-{% if trend == 'up' %}success{% elif trend == 'down' %}danger{% else %}secondary{% endif %} bg-opacity-10 text-{% if trend == 'up' %}success{% elif trend == 'down' %}danger{% else %}secondary{% endif %}">
        {{ icon("trending-" + trend if trend in ['up', 'down'] else "minus", "sm", "me-1") }}
        {{ trend_value }}
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endmacro %}



{% macro loading_state(message="加载中...", size="md", theme="primary", overlay=false) %}
<!-- 加载状态组件 -->
<div class="text-center py-4 {% if overlay %}loading-overlay{% endif %}">
  <div class="{% if size == 'sm' %}mb-2{% elif size == 'lg' %}mb-4{% else %}mb-3{% endif %}">
    <div class="spinner-border text-{{ theme }} {% if size == 'sm' %}spinner-border-sm{% elif size == 'lg' %}spinner-border-lg{% endif %}" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
  </div>
  <p class="{% if size == 'sm' %}small{% elif size == 'lg' %}fs-5{% endif %} text-{% if theme == 'light' %}white{% else %}muted{% endif %}">{{ message }}</p>
</div>
{% endmacro %}



{% macro modal(id, title, size="", centered=true, scrollable=false, static_backdrop=true) %}
<!-- 模态框组件 -->
<div class="modal fade" id="{{ id }}" tabindex="-1" aria-labelledby="{{ id }}-label" aria-hidden="true"
     {% if static_backdrop %}data-bs-backdrop="static" data-bs-keyboard="false"{% endif %}>
  <div class="modal-dialog {% if size %}modal-{{ size }}{% endif %} {% if centered %}modal-dialog-centered{% endif %} {% if scrollable %}modal-dialog-scrollable{% endif %}">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="{{ id }}-label">{{ title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        {{ caller() }}
      </div>
      {% if caller().footer is defined %}
      <div class="modal-footer">
        {{ caller().footer }}
      </div>
      {% else %}
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" id="{{ id }}-confirm">确认</button>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endmacro %}

{% macro alert_banner(message, type="info", dismissible=true, icon_name="", extra_classes="") %}
<!-- 通知横幅组件 -->
<div class="alert alert-{{ type }} {% if dismissible %}alert-dismissible fade show{% endif %} {{ extra_classes }}">
  {% if icon_name %}
    {{ icon(icon_name, "sm", "me-2") }}
  {% elif type == 'success' %}
    {{ icon("check-circle", "sm", "me-2") }}
  {% elif type == 'danger' %}
    {{ icon("x-circle", "sm", "me-2") }}
  {% elif type == 'warning' %}
    {{ icon("alert-triangle", "sm", "me-2") }}
  {% else %}
    {{ icon("info", "sm", "me-2") }}
  {% endif %}
  {{ message }}
  {% if dismissible %}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="关闭"></button>
  {% endif %}
</div>
{% endmacro %}

{% macro no_data_guide() %}
<!-- 无数据状态引导 -->
<div class="no-data-overlay">
    <div class="no-data-content">
        <div class="mb-4">
            {{ icon("database-x", "xxl", "text-muted") }}
        </div>
        <h3 class="mb-3">欢迎使用 AiBookkeeping</h3>
        <a href="{{ url_for('settings_bp.settings_index') }}" class="btn btn-primary btn-lg">
            {{ icon("upload", "sm", "me-2") }}
            立即导入数据
        </a>
    </div>
</div>
{% endmacro %}