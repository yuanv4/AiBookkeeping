{% extends "base.html" %}
{% from "macros.html" import icon, card, chart_container, page_header, stat_card, loading_state %}

{% block title %}财务分析中心 - {{ config.APP_NAME }}{% endblock %}

{% block page_css %}
<link href="{{ url_for('static', filename='css/pages/analysis.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="page-container">
    {{ page_header("财务分析中心", "现金流健康监控与支出分类分析", "bar-chart-3") }}
    
    <!-- 统一的数据容器 -->
    <div id="analysis-data" 
         data-dashboard-data='{{ dashboard_data|tojson|safe }}'
         data-categories-config='{{ categories_config|tojson|safe }}'
         style="display: none;">
    </div>
    
    <!-- 核心健康指标区域 (来自仪表盘) -->
    <section id="health-metrics" class="mb-4">
        <!-- 净现金趋势图 -->
        <div class="row mb-4">
            <div class="col-12">
                {{ chart_container("净现金趋势", "netWorthChart", "300px", "trending-up") }}
            </div>
        </div>
        
        <!-- KPI 指标卡片 -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
            <div class="col">{{ stat_card("dollar-sign", "¥0.00", "当前总现金", "primary", "", "currentAssets") }}</div>
            <div class="col">{{ stat_card("shield-check", "0个月", "应急储备月数", "warning", "", "emergencyReserveMonths") }}</div>
            <div class="col">{{ stat_card("calculator", "¥0.00", "累计净收支", "info", "", "netIncome", "--", "netChange") }}</div>
        </div>
    </section>
    
    <!-- 支出分析区域 (来自支出分析) -->
    <section id="expense-analysis" class="mb-4">
        <!-- 月度趋势图表 -->
        <div class="row mb-4">
            <div class="col-12">
                {{ chart_container("月度支出分类趋势", "monthly-trend-chart", "350px", "trending-up", false, false, false) }}
            </div>
        </div>

        <!-- 支出分类详情 -->
        <div class="row mb-4">
            <div class="col-12">
                {% call card("支出分类详情", "pie-chart", "", "p-0") %}
                    <div class="px-3 pt-0 pb-2">
                        <small class="text-muted">
                            按商户类型分类显示支出详情，点击类别卡片查看该类别下的商户明细
                        </small>
                    </div>

                    <!-- 分类汇总卡片列表 -->
                    <div id="expense-categories" class="px-3 pb-3">
                        <!-- 动态加载分类汇总卡片 -->
                    </div>
                {% endcall %}
            </div>
        </div>
    </section>

    <!-- 加载状态 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载数据...</p>
        </div>
    </div>

    <!-- 错误状态 -->
    <div id="error-state" class="text-center py-5" style="display: none;">
        <div class="text-danger mb-3">
            {{ icon('alert-circle', 'fs-1') }}
        </div>
        <h5 class="text-danger">数据加载失败</h5>
        <p class="text-muted mb-3" id="error-message">
            请稍后重试或联系管理员
        </p>
        <button class="btn btn-primary" onclick="location.reload()">
            {{ icon('refresh-cw', 'me-2') }}
            重新加载
        </button>
    </div>
</div>
{% endblock %}

{% block page_vendor_scripts %}
<!-- Apache ECharts - 现代化图表库 -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    // 确保ECharts正确加载
    if (typeof echarts !== 'undefined') {
        console.log('ECharts loaded successfully, version:', echarts.version);
    } else {
        console.error('ECharts failed to load');
    }
</script>
{% endblock %}

{% block page_scripts %}
<!-- 财务分析页面脚本 -->
<script type="module" src="{{ url_for('static', filename='js/pages/analysis.js') }}"></script>
<script>
    // 全局页面实例，供内联事件处理器使用
    window.analysisPage = null;

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('财务分析页面开始初始化');
    });
</script>
{% endblock %}
