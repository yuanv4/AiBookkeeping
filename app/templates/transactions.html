{% extends "base.html" %}
{% from "macros.html" import icon, data_table, filter_form, filter_input %}

{% block title %}交易记录 - 银行账单分析系统{% endblock %}

{% block header_title %}交易记录{% endblock %}

{% block page_css %}
<link href="{{ url_for('static', filename='css/transactions.css') }}" rel="stylesheet">
{% endblock %}

{% block page_scripts %}
<!-- 延迟加载交易页面特定脚本 -->
<script src="{{ url_for('static', filename='js/transactions.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-2">交易记录</h1>
        <p class="subheading">查看和搜索您的所有交易记录，共 <span class="badge bg-primary rounded-pill" id="total-count">{{ total_count }}</span> 条</p>
    </div>
</div>

<!-- 分页数据元素 -->
<div id="current-page-data" 
     data-page="{{ data.pagination.page }}" 
     data-limit="{{ data.pagination.limit }}" 
     data-pages="{{ data.pagination.pages }}"
     style="display: none;"></div>

<!-- 交易数据元素 -->
<div id="transactions-data" 
     data-transactions='{{ data.transactions | tojson | safe }}' 
     style="display: none;"></div>

<!-- 银行账户数据元素 -->
<!-- <div id="bank-accounts-data" 
     data-accounts='{{ bank_accounts_json|safe if bank_accounts_json else "[]" }}' 
     style="display: none;"></div> -->

<!-- 调试信息（仅开发环境可见） -->
<div id="debug-info" class="d-none">
    <p>页数: {{ data.pagination.page }}/{{ data.pagination.pages }}</p>
    <p>每页显示: {{ data.pagination.limit }}</p>
    <p>当前筛选: {{ data.filters }}</p>
    <p>记录数: {{ data.transactions|length }}</p>
</div>

<!-- 筛选表单 -->
<div class="card mb-4 filter-form-container">
    <div class="card-header">
        <div class="d-flex align-items-center">
            {{ icon("filter_list", "md", "icon-primary", "me-2") }}
            <span>筛选条件</span>
        </div>
    </div>
    <div class="card-body">
        {% call filter_form() %}
            {{ filter_input("交易类型", "category", "category", "select", data.categories) }}
            {{ filter_input("银行/卡号", "account_balance", "bankAccount", "select", data.accounts) }}
            {{ filter_input("关键词搜索", "search", "search", "text", placeholder="输入关键词...") }}
        {% endcall %}
    </div>
</div>

<!-- 交易记录表格 -->
{{ data_table("transactions-table", 
              ["序号", "日期", "类型", "交易对象", "金额", "账户余额", "账号", "银行"],
              true, 
              total=total_count, 
              filtered=data.transactions|length) }}
{% endblock %}

{% block scripts %}
<style>
    .positive {
        color: #28a745;
        font-weight: bold;
    }
    .negative {
        color: #dc3545;
        font-weight: bold;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('交易记录页面DOM加载完成');
        
        // 初始化银行账户选择器 (这段逻辑现在由 filter_input 宏通过 data.accounts 处理)
        /*
        const bankAccountsData = document.getElementById('bank-accounts-data');
        if (bankAccountsData) {
            const accounts = JSON.parse(bankAccountsData.dataset.accounts);
            const bankAccountSelect = document.getElementById('bankAccount');
            
            if (bankAccountSelect && accounts.length > 0) {
                // 清空现有选项
                bankAccountSelect.innerHTML = '<option value="">全部</option>';
                
                // 添加银行账户选项
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.bank_name} (${account.account_number})`;
                    bankAccountSelect.appendChild(option);
                });
            }
        }
        */
        
        // 检查关键元素
        setTimeout(function() {
        }, 1000);
    });
</script>
{% endblock %}