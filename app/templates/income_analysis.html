{% extends "base.html" %}
{% from "macros.html" import icon, card, chart_container, page_header %}

{% block title %}收入分析 - {{ config.APP_NAME }}{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') }}">
{% endblock %}

{% block content %}
<div class="page-container">
    {{ page_header("收入分析", "深入分析您的收入结构", "analytics") }}

    <!-- 分析图表网格 -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <!-- 收入与支出平衡分析 -->
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-1">收入与支出平衡分析</h5>
                        <p class="card-subtitle mb-0">分析收支差额比率、必要支出覆盖率和储蓄率</p>
                    </div>
                    <div class="icon-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 2.5rem; height: 2.5rem; border-radius: 50%;">
                        {{ icon("scale", "md", "text-primary") }}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-xl-8 col-lg-12 col-md-8">
                            <div class="chart-container">
                                <canvas id="incomeExpenseChart"></canvas>
                            </div>
                        </div>
                        <div class="col-xl-4 col-lg-12 col-md-4">
                            <div class="stat-container">
                                <div class="stat-item">
                                    <div class="stat-label">平均收支比率</div>
                                    <div class="stat-value">{% if data and data.income_expense_balance and data.income_expense_balance.overall_stats %}{{ "%.2f"|format(data.income_expense_balance.overall_stats.avg_monthly_ratio) }}{% else %}0.00{% endif %}</div>
                                    <div class="stat-description">比值大于1表示收入大于支出</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">平均储蓄率</div>
                                    <div class="stat-value">{% if data and data.income_expense_balance and data.income_expense_balance.overall_stats %}{{ "%.1f"|format(data.income_expense_balance.overall_stats.avg_monthly_saving_rate * 100) }}%{% else %}0.0%{% endif %}</div>
                                    <div class="stat-description">收入中节省的比例</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">必要支出覆盖率</div>
                                    <div class="stat-value">{% if data and data.income_expense_balance and data.income_expense_balance.overall_stats %}{{ "%.2f"|format(data.income_expense_balance.overall_stats.avg_necessary_expense_coverage) }}{% else %}0.00{% endif %}</div>
                                    <div class="stat-description">收入对必要生活支出的覆盖倍数</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <!-- 收入稳定性分析 -->
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-1">收入稳定性分析</h5>
                        <p class="card-subtitle mb-0">分析固定收入占比、收入波动和收入周期</p>
                    </div>
                    <div class="icon-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 2.5rem; height: 2.5rem; border-radius: 50%;">
                        {{ icon("trending-up", "md", "text-primary") }}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-xl-8 col-lg-12 col-md-8">
                            <div class="chart-container">
                                <canvas id="incomeStabilityChart"></canvas>
                            </div>
                        </div>
                        <div class="col-xl-4 col-lg-12 col-md-4">
                            <div class="stat-container">
                                <div class="stat-item">
                                    <div class="stat-label">固定收入占比</div>
                                    <div class="stat-value">{% if data and data.income_stability and data.income_stability.overall_stats %}{{ "%.1f"|format(data.income_stability.overall_stats.fixed_income_ratio * 100) }}%{% else %}0.0%{% endif %}</div>
                                    <div class="stat-description">固定收入提供稳定的财务基础</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">收入变异系数</div>
                                    <div class="stat-value">{% if data and data.income_stability and data.income_stability.overall_stats %}{{ "%.3f"|format(data.income_stability.overall_stats.income_coefficient_variation) }}{% else %}0.000{% endif %}</div>
                                    <div class="stat-description">数值越小表示收入越稳定</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">收入趋势</div>
                                    <div class="stat-value">{% if data and data.income_stability and data.income_stability.overall_stats %}{{ "%.1f"|format(data.income_stability.overall_stats.income_trend_slope) }}%{% else %}0.0%{% endif %}</div>
                                    <div class="stat-description">正值表示收入呈上升趋势</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 详细分析图表网格 -->
    <div class="row g-4 mb-4">
        <div class="col-12">
        <!-- 月度收入趋势分析 -->
        {% call chart_container("月度收入趋势分析 (最近12个月)", "monthlyIncomeChart") %}
        {% if data and data.monthly_income_trend and data.monthly_income_trend|length > 0 %}
        <div class="chart-legend flex-wrap">
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(34, 197, 94, 1);"></div>
                <span>总收入</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(59, 130, 246, 1);"></div>
                <span>固定收入</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(168, 85, 247, 1);"></div>
                <span>变动收入</span>
            </div>
        </div>
        
        <!-- 收入趋势统计 -->
        <div class="stats-container horizontal mt-3">
            <div class="stat-item">
                <div class="stat-label">平均月收入</div>
                <div class="stat-value">¥{% if data and data.monthly_income_trend %}{{ "%.2f"|format((data.monthly_income_trend|sum(attribute='total_income')) / (data.monthly_income_trend|length)) }}{% else %}0.00{% endif %}</div>
                <div class="stat-description">过去12个月的平均收入水平</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">收入增长率</div>
                <div class="stat-value">{% if data and data.monthly_income_trend and data.monthly_income_trend|length >= 2 %}{{ "%.1f"|format(((data.monthly_income_trend[-1].total_income - data.monthly_income_trend[0].total_income) / data.monthly_income_trend[0].total_income * 100) if data.monthly_income_trend[0].total_income > 0 else 0) }}%{% else %}0.0%{% endif %}</div>
                <div class="stat-description">相比首月的增长幅度</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">最高月收入</div>
                <div class="stat-value">¥{% if data and data.monthly_income_trend %}{{ "%.2f"|format(data.monthly_income_trend|max(attribute='total_income')|attr('total_income')) }}{% else %}0.00{% endif %}</div>
                <div class="stat-description">过去12个月的收入峰值</div>
            </div>
        </div>
        {% endif %}
        {% endcall %}
        </div>
    </div>

    <!-- 收入来源分析 -->
    <div class="row g-4">
        <div class="col-12">
            <!-- 收入来源分布 -->
            {% call chart_container("收入来源分布", "incomeSourceChart") %}
            {% if data and data.income_sources and data.income_sources|length > 0 %}
            <div class="stats-container horizontal">
                {% for source in data.income_sources[:4] %}
                <div class="stat-item">
                    <div class="stat-label">{{ source.source_type }}</div>
                    <div class="stat-value">¥{{ "%.2f"|format(source.total_amount) }}</div>
                    <div class="stat-description">{{ "%.1f"|format(source.percentage) }}%</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endcall %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/income_analysis.js') }}"></script>
{% endblock %}