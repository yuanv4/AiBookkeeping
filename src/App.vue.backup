<template>
  <div class="container">
    <header class="header">
      <h1>ğŸ“Š AI è´¦å•æ±‡é›†å·¥å…·</h1>
      <p>æ”¯æŒå¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ã€å„å¤§é“¶è¡Œè´¦å•çš„æ™ºèƒ½å¯¹é½ä¸åˆå¹¶</p>
    </header>

    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div class="card">
      <div
        class="upload-area"
        :class="{ dragging }"
        @dragover.prevent="dragging = true"
        @dragleave.prevent="dragging = false"
        @drop.prevent="handleDrop"
      >
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
        <div class="upload-hint">æ”¯æŒå¾®ä¿¡è´¦å•(xlsx)ã€æ”¯ä»˜å®è´¦å•(csv)ã€é“¶è¡Œè´¦å•(xls/pdf)</div>
        <input
          ref="fileInput"
          type="file"
          multiple
          accept=".csv,.xlsx,.xls,.pdf"
          @change="handleFileSelect"
          class="file-input"
        />
      </div>

      <!-- æ–‡ä»¶åˆ—è¡¨ -->
      <div v-if="files.length > 0" class="file-list">
        <div v-for="file in files" :key="file.id" class="file-item">
          <div class="file-info">
            <span class="file-icon">{{ getFileIcon(file) }}</span>
            <div class="file-details">
              <span class="file-name">{{ file.name }}</span>
              <span class="file-meta">{{ formatFileSize(file.size) }} Â· {{ file.platform || 'æœªè¯†åˆ«' }}</span>
            </div>
          </div>
          <button class="btn btn-danger" @click="removeFile(file.id)">åˆ é™¤</button>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div style="margin-top: 20px; text-align: center">
        <button
          class="btn btn-primary"
          :disabled="files.length === 0 || processing"
          @click="processFiles"
        >
          {{ processing ? 'å¤„ç†ä¸­...' : 'å¼€å§‹å¤„ç†è´¦å•' }}
        </button>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="processing" class="card loading">
      <div class="spinner"></div>
      <span>æ­£åœ¨è§£æè´¦å•æ–‡ä»¶ï¼Œè¯·ç¨å€™...</span>
    </div>

    <!-- ç»Ÿè®¡æ‘˜è¦ -->
    <div v-if="transactions.length > 0" class="summary-cards">
      <div class="summary-card">
        <div class="icon">ğŸ“‹</div>
        <div class="label">æ€»äº¤æ˜“ç¬”æ•°</div>
        <div class="value">{{ statistics.total }}</div>
      </div>
      <div class="summary-card income">
        <div class="icon">ğŸ’°</div>
        <div class="label">æ€»æ”¶å…¥</div>
        <div class="value">Â¥{{ statistics.income.toFixed(2) }}</div>
      </div>
      <div class="summary-card expense">
        <div class="icon">ğŸ’¸</div>
        <div class="label">æ€»æ”¯å‡º</div>
        <div class="value">Â¥{{ Math.abs(statistics.expense).toFixed(2) }}</div>
      </div>
      <div class="summary-card">
        <div class="icon">ğŸ“Š</div>
        <div class="label">å‡€æ”¶æ”¯</div>
        <div class="value" :style="{ color: statistics.net >= 0 ? '#28a745' : '#dc3545' }">
          Â¥{{ statistics.net.toFixed(2) }}
        </div>
      </div>
    </div>

    <!-- ç­›é€‰å™¨å’ŒTabåˆ‡æ¢ -->
    <div v-if="transactions.length > 0" class="card">
      <div class="filters">
        <div class="filter-group search-box">
          <input
            v-model="searchQuery"
            type="text"
            placeholder="æœç´¢äº¤æ˜“å¯¹æ–¹ã€å•†å“æè¿°..."
          />
        </div>
        <div class="filter-group">
          <label>å¹³å°:</label>
          <select v-model="filterPlatform">
            <option value="">å…¨éƒ¨</option>
            <option value="alipay">æ”¯ä»˜å®</option>
            <option value="wechat">å¾®ä¿¡æ”¯ä»˜</option>
            <option value="bank">é“¶è¡Œ</option>
          </select>
        </div>
        <div class="filter-group">
          <label>ç±»å‹:</label>
          <select v-model="filterType">
            <option value="">å…¨éƒ¨</option>
            <option value="income">æ”¶å…¥</option>
            <option value="expense">æ”¯å‡º</option>
          </select>
        </div>
        <div class="filter-group">
          <label>åˆ†ç±»:</label>
          <select v-model="filterCategory">
            <option value="">å…¨éƒ¨</option>
            <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
          </select>
        </div>
        <button class="btn btn-success" @click="exportTransactions">å¯¼å‡ºExcel</button>
      </div>
    </div>

    <!-- Tab åˆ‡æ¢ -->
    <div v-if="transactions.length > 0" class="tab-container">
      <button
        v-for="tab in tabs"
        :key="tab.key"
        @click="activeTab = tab.key"
        class="tab-button"
        :class="{ active: activeTab === tab.key }"
      >
        {{ tab.label }}
      </button>
    </div>

    <!-- äº¤æ˜“æ˜ç»†è¡¨æ ¼ -->
    <div v-if="transactions.length > 0 && activeTab === 'table'" class="card">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>äº¤æ˜“æ—¶é—´</th>
              <th>å¹³å°</th>
              <th>ç±»å‹</th>
              <th>åˆ†ç±»</th>
              <th>äº¤æ˜“å¯¹æ–¹</th>
              <th>æè¿°</th>
              <th>é‡‘é¢</th>
              <th>æ”¯ä»˜æ–¹å¼</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="tx in paginatedTransactions" :key="tx.id">
              <td>{{ formatDateTime(tx.transactionTime) }}</td>
              <td>
                <span class="badge" :class="`badge-${tx.platform}`">
                  {{ getPlatformLabel(tx.platform, tx.bankName) }}
                </span>
              </td>
              <td>
                <span class="badge" :class="`badge-${tx.transactionType}`">
                  {{ tx.transactionType === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º' }}
                </span>
              </td>
              <td>
                <span v-if="tx.category" class="category-badge" :style="{ backgroundColor: getCategoryColor(tx.category) }">
                  {{ getCategoryIcon(tx.category) }} {{ tx.category }}
                </span>
                <span v-else class="text-muted">æœªåˆ†ç±»</span>
              </td>
              <td>{{ tx.counterparty || '-' }}</td>
              <td>{{ tx.description || '-' }}</td>
              <td :style="{ color: tx.amount >= 0 ? '#28a745' : '#dc3545' }">
                {{ tx.amount >= 0 ? '+' : '' }}{{ tx.amount.toFixed(2) }}
              </td>
              <td>{{ tx.paymentMethod || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- åˆ†é¡µ -->
      <div class="pagination">
        <button
          class="btn"
          :disabled="currentPage === 1"
          @click="currentPage--"
        >
          ä¸Šä¸€é¡µ
        </button>
        <span>ç¬¬ {{ currentPage }} / {{ totalPages }} é¡µ</span>
        <button
          class="btn"
          :disabled="currentPage === totalPages"
          @click="currentPage++"
        >
          ä¸‹ä¸€é¡µ
        </button>
      </div>
    </div>

    <!-- å›¾è¡¨åˆ†æé¢æ¿ -->
    <AnalysisPanel
      v-if="transactions.length > 0 && activeTab === 'analysis'"
      :transactions="transactions"
      @category-filter="handleCategoryFilter"
    />

    <!-- ç©ºçŠ¶æ€ -->
    <div v-if="!processing && transactions.length === 0 && files.length === 0" class="card empty-state">
      <div class="icon">ğŸ“Š</div>
      <h3>è¿˜æ²¡æœ‰è´¦å•æ•°æ®</h3>
      <p>è¯·ä¸Šä¼ å¾®ä¿¡ã€æ”¯ä»˜å®æˆ–é“¶è¡Œçš„è´¦å•æ–‡ä»¶å¼€å§‹åˆ†æ</p>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import * as XLSX from 'xlsx'
import Papa from 'papaparse'
import {
  mapTransactions,
  mergeTransactions,
  deduplicateTransactions
} from './utils/dataModel.js'
import { batchCategorize } from './utils/categorizer.js'
import { loadAIConfig } from './config/aiConfig.js'
import { CATEGORIES, getCategoryIcon, getCategoryColor } from './utils/categoryRules.js'
import AnalysisPanel from './components/analysis/AnalysisPanel.vue'

// çŠ¶æ€
const files = ref([])
const transactions = ref([])
const processing = ref(false)
const dragging = ref(false)
const fileInput = ref(null)
const activeTab = ref('table') // 'table' | 'analysis'

// Tab é…ç½®
const tabs = [
  { key: 'table', label: 'ğŸ“‹ æ˜ç»†è¡¨æ ¼' },
  { key: 'analysis', label: 'ğŸ“Š å›¾è¡¨åˆ†æ' }
]

// åˆ†ç±»åˆ—è¡¨
const categories = CATEGORIES

// ç­›é€‰å’Œåˆ†é¡µ
const searchQuery = ref('')
const filterPlatform = ref('')
const filterType = ref('')
const filterCategory = ref('')
const currentPage = ref(1)
const pageSize = 50

// ç»Ÿè®¡ä¿¡æ¯
const statistics = computed(() => {
  const total = transactions.value.length
  const income = transactions.value
    .filter(t => t.amount > 0)
    .reduce((sum, t) => sum + t.amount, 0)
  const expense = transactions.value
    .filter(t => t.amount < 0)
    .reduce((sum, t) => sum + t.amount, 0)

  return {
    total,
    income,
    expense,
    net: income + expense
  }
})

// ç­›é€‰åçš„äº¤æ˜“
const filteredTransactions = computed(() => {
  let result = transactions.value

  // æœç´¢ç­›é€‰
  if (searchQuery.value) {
    const query = searchQuery.value.toLowerCase()
    result = result.filter(t =>
      (t.counterparty || '').toLowerCase().includes(query) ||
      (t.description || '').toLowerCase().includes(query)
    )
  }

  // å¹³å°ç­›é€‰
  if (filterPlatform.value) {
    result = result.filter(t => t.platform === filterPlatform.value)
  }

  // ç±»å‹ç­›é€‰
  if (filterType.value) {
    result = result.filter(t => t.transactionType === filterType.value)
  }

  // åˆ†ç±»ç­›é€‰
  if (filterCategory.value) {
    result = result.filter(t => (t.category || 'å…¶ä»–') === filterCategory.value)
  }

  return result
})

// åˆ†é¡µåçš„äº¤æ˜“
const paginatedTransactions = computed(() => {
  const start = (currentPage.value - 1) * pageSize
  const end = start + pageSize
  return filteredTransactions.value.slice(start, end)
})

// æ€»é¡µæ•°
const totalPages = computed(() => {
  return Math.ceil(filteredTransactions.value.length / pageSize)
})

// å¤„ç†æ–‡ä»¶é€‰æ‹©
function handleFileSelect(event) {
  const selectedFiles = Array.from(event.target.files || [])
  addFiles(selectedFiles)
  // æ¸…ç©ºinputå€¼,å…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
  event.target.value = ''
}

// å¤„ç†æ‹–æ”¾
function handleDrop(event) {
  dragging.value = false
  const droppedFiles = Array.from(event.dataTransfer?.files || [])
  addFiles(droppedFiles)
}

// æ·»åŠ æ–‡ä»¶
function addFiles(newFiles) {
  newFiles.forEach(file => {
    const id = Date.now() + Math.random().toString(36).substr(2, 9)
    const platform = detectPlatform(file)
    files.value.push({
      id,
      platform,
      name: file.name,
      size: file.size,
      type: file.type,
      lastModified: file.lastModified,
      raw: file
    })
  })
}

// åˆ é™¤æ–‡ä»¶
function removeFile(id) {
  files.value = files.value.filter(f => f.id !== id)
}

// æ£€æµ‹å¹³å°
function detectPlatform(file) {
  const name = file.name.toLowerCase()

  if (name.includes('æ”¯ä»˜å®') || name.includes('alipay')) {
    return 'alipay'
  }
  if (name.includes('å¾®ä¿¡') || name.includes('wechat') || name.includes('weixin')) {
    return 'wechat'
  }
  if (name.includes('å»ºè®¾é“¶è¡Œ') || name.includes('ccb')) {
    return 'ccb'
  }
  if (name.includes('æ‹›å•†é“¶è¡Œ') || name.includes('cmb')) {
    return 'cmb'
  }

  // æ ¹æ®æ‰©å±•åçŒœæµ‹
  if (name.endsWith('.csv')) return 'alipay'
  if (name.endsWith('.xlsx')) return 'wechat'
  if (name.endsWith('.xls')) return 'bank'
  if (name.endsWith('.pdf')) return 'bank'

  return 'unknown'
}

// è·å–æ–‡ä»¶å›¾æ ‡
function getFileIcon(file) {
  if (!file || !file.name) return 'ğŸ“„'
  const name = file.name.toLowerCase()
  if (name.includes('æ”¯ä»˜å®') || file.platform === 'alipay') return 'ğŸ’™'
  if (name.includes('å¾®ä¿¡') || file.platform === 'wechat') return 'ğŸ’š'
  if (file.platform?.includes('ccb') || file.platform?.includes('cmb')) return 'ğŸ¦'
  return 'ğŸ“„'
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
  if (bytes === undefined || bytes === null) return '0 B'
  if (bytes < 1024) return bytes + ' B'
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB'
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(isoString) {
  if (!isoString) return '-'
  const date = new Date(isoString)
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  })
}

// è·å–å¹³å°æ ‡ç­¾
function getPlatformLabel(platform, bankName) {
  const labels = {
    alipay: 'æ”¯ä»˜å®',
    wechat: 'å¾®ä¿¡æ”¯ä»˜',
    bank: bankName || 'é“¶è¡Œ'
  }
  return labels[platform] || platform
}

// å¤„ç†æ–‡ä»¶
async function processFiles() {
  processing.value = true
  const allTransactions = []

  try {
    for (const file of files.value) {
      const transactions = await parseFile(file.raw || file)
      allTransactions.push(...transactions)
    }

    // åˆå¹¶å’Œå»é‡
    const uniqueTransactions = deduplicateTransactions(allTransactions)

    // è‡ªåŠ¨åˆ†ç±»
    console.log('ğŸ·ï¸ å¼€å§‹è‡ªåŠ¨åˆ†ç±»äº¤æ˜“...')
    const aiConfig = loadAIConfig()
    const categorizedTransactions = await batchCategorize(uniqueTransactions, {
      useAI: aiConfig.enabled,
      aiConfig: aiConfig,
      fallbackToRules: true
    })

    transactions.value = categorizedTransactions
    console.log(`âœ… åˆ†ç±»å®Œæˆï¼Œå…± ${categorizedTransactions.length} æ¡äº¤æ˜“`)
  } catch (error) {
    console.error('å¤„ç†æ–‡ä»¶å¤±è´¥:', error)
    alert('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + error.message)
  } finally {
    processing.value = false
  }
}

// è§£ææ–‡ä»¶
async function parseFile(file) {
  let platform = file.platform || detectPlatform(file)
  let bankName = ''

  // å°†å…·ä½“çš„é“¶è¡Œä»£ç ç»Ÿä¸€ä¸º 'bank'
  if (platform === 'ccb' || platform === 'cmb' || platform === 'bank') {
    bankName = getBankName(platform)
    platform = 'bank'
  }

  // CSVæ–‡ä»¶ï¼ˆæ”¯ä»˜å®ï¼‰
  if (file.name.endsWith('.csv')) {
    return await parseCSV(file, platform)
  }

  // Excelæ–‡ä»¶ï¼ˆå¾®ä¿¡ã€å»ºè¡Œï¼‰
  if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
    return await parseExcel(file, platform, bankName)
  }

  // PDFæ–‡ä»¶ï¼ˆæ‹›å•†é“¶è¡Œï¼‰
  if (file.name.endsWith('.pdf')) {
    return await parsePDF(file, platform, bankName)
  }

  throw new Error(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.name}`)
}

// è·å–é“¶è¡Œåç§°
function getBankName(platform) {
  const names = {
    ccb: 'å»ºè®¾é“¶è¡Œ',
    cmb: 'æ‹›å•†é“¶è¡Œ'
  }
  return names[platform] || 'é“¶è¡Œ'
}

// è§£æCSVï¼ˆæ”¯ä»˜å®ï¼‰
function parseCSV(file, platform) {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      encoding: 'GBK', // æ”¯ä»˜å®ä½¿ç”¨GBKç¼–ç 
      complete: (results) => {
        try {
          // æ‰¾åˆ°æ•°æ®å¼€å§‹çš„è¡Œï¼ˆè·³è¿‡è¯´æ˜éƒ¨åˆ†ï¼‰
          const dataStartIndex = results.data.findIndex(row =>
            row[0] && row[0].includes('äº¤æ˜“æ—¶é—´')
          )

          if (dataStartIndex === -1) {
            resolve([])
            return
          }

          // æå–åˆ—åå’Œæ•°æ®
          const headers = results.data[dataStartIndex]
          const dataRows = results.data.slice(dataStartIndex + 1)

          // è½¬æ¢ä¸ºå¯¹è±¡æ•°ç»„
          const objects = dataRows
            .filter(row => row[0] && row[0].match(/\d{4}-\d{2}-\d{2}/))
            .map(row => {
              const obj = {}
              headers.forEach((header, index) => {
                if (header) obj[header.trim()] = row[index] || ''
              })
              return obj
            })
            .filter(obj => Object.keys(obj).length > 0)

          const mapped = mapTransactions(objects, platform)
          resolve(mapped)
        } catch (error) {
          reject(error)
        }
      },
      error: reject
    })
  })
}

// è§£æExcel
async function parseExcel(file, platform, bankName = '') {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()

    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result)
        const workbook = XLSX.read(data, { type: 'array' })
        const sheetName = workbook.SheetNames[0]
        const worksheet = workbook.Sheets[sheetName]

        // æ ¹æ®ä¸åŒå¹³å°è·³è¿‡è¯´æ˜è¡Œ
        let jsonData
        if (platform === 'wechat' || file.name.toLowerCase().includes('å¾®ä¿¡')) {
          // å¾®ä¿¡è´¦å•éœ€è¦è·³è¿‡å‰16è¡Œè¯´æ˜
          jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 16 })
        } else if (platform === 'bank') {
          // å»ºè®¾é“¶è¡Œç­‰é“¶è¡Œè´¦å•éœ€è¦è·³è¿‡å‰3è¡Œè¯´æ˜
          jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 2 })
        } else {
          jsonData = XLSX.utils.sheet_to_json(worksheet)
        }

        const mapped = mapTransactions(jsonData, platform, bankName)
        resolve(mapped)
      } catch (error) {
        reject(error)
      }
    }

    reader.onerror = reject
    reader.readAsArrayBuffer(file)
  })
}

// è§£æPDFï¼ˆæ‹›å•†é“¶è¡Œï¼‰
async function parsePDF(file, platform, bankName = 'æ‹›å•†é“¶è¡Œ') {
  try {
    // ä½¿ç”¨æ–°çš„ PDF è§£æå·¥å…·
    const { parseCMBPDF } = await import('./utils/pdfParser.js')
    console.log(`ğŸ“„ å¼€å§‹è§£æPDF: ${file.name}`)
    const transactions = await parseCMBPDF(file)
    console.log(`âœ… PDFè§£æå®Œæˆ,æå– ${transactions.length} æ¡äº¤æ˜“è®°å½•`)
    return transactions
  } catch (error) {
    console.error('âŒ PDFè§£æå¤±è´¥:', error)
    throw new Error(`PDFè§£æå¤±è´¥: ${error.message}`)
  }
}

// å¯¼å‡ºäº¤æ˜“
function exportTransactions() {
  if (filteredTransactions.value.length === 0) {
    alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®')
    return
  }

  // å‡†å¤‡å¯¼å‡ºæ•°æ®
  const exportData = filteredTransactions.value.map(t => ({
    'äº¤æ˜“æ—¶é—´': formatDateTime(t.transactionTime),
    'å¹³å°': getPlatformLabel(t.platform, t.bankName),
    'ç±»å‹': t.transactionType === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
    'äº¤æ˜“å¯¹æ–¹': t.counterparty || '',
    'æè¿°': t.description || '',
    'é‡‘é¢': t.amount,
    'æ”¯ä»˜æ–¹å¼': t.paymentMethod || ''
  }))

  // åˆ›å»ºå·¥ä½œè¡¨
  const worksheet = XLSX.utils.json_to_sheet(exportData)
  const workbook = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(workbook, worksheet, 'è´¦å•æ˜ç»†')

  // å¯¼å‡º
  XLSX.writeFile(workbook, `è´¦å•æ±‡æ€»_${new Date().toISOString().slice(0, 10)}.xlsx`)
}

// ç›‘å¬ç­›é€‰å˜åŒ–é‡ç½®é¡µç 
function watchFilters() {
  currentPage.value = 1
}

// ç›‘å¬ç­›é€‰å™¨
;[searchQuery, filterPlatform, filterType, filterCategory].forEach(ref => {
  ref.value && watchFilters()
})

// å¤„ç†åˆ†ç±»ç­›é€‰ï¼ˆä»åˆ†æé¢æ¿ï¼‰
function handleCategoryFilter(category) {
  filterCategory.value = category || ''
  activeTab.value = 'table' // åˆ‡æ¢å›è¡¨æ ¼è§†å›¾
}
</script>
